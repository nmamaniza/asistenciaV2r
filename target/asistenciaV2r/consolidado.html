<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consolidado - Sistema de Asistencia</title>
    <script id="sap-ui-bootstrap" src="https://openui5.hana.ondemand.com/resources/sap-ui-core.js"
        data-sap-ui-libs="sap.m,sap.ui.table" data-sap-ui-theme="sap_horizon">
        </script>
    <script src="/asistenciaV2r/js/menu-manager.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }

        .header {
            background-color: #3498db;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        /* Estilos del men√∫ de usuario */
        .user-menu {
            position: relative;
            display: inline-block;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ffffff;
            color: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .user-avatar:hover {
            background-color: #f0f0f0;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 220px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 5px;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-header {
            padding: 12px 16px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            font-weight: bold;
            color: #495057;
        }

        .dropdown-item {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background-color 0.3s ease;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-item.logout {
            border-top: 1px solid #e9ecef;
            color: #dc3545;
        }

        .dropdown-item.logout:hover {
            background-color: #f8d7da;
        }

        .content {
            padding: 1rem;
            max-width: 100%;
            margin: 0;
        }

        .filters-section {
            background-color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .filters-row {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }

        .filter-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .filter-group input,
        .filter-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            height: fit-content;
        }

        .search-btn:hover {
            background-color: #2980b9;
        }

        .export-btn {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }

        .export-btn:hover {
            background-color: #229954;
        }

        .table-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: auto;
            height: calc(100vh - 180px);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .summary-card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .summary-card h3 {
            margin: 0 0 10px 0;
            color: #3498db;
            font-size: 2rem;
        }

        .summary-card p {
            margin: 0;
            color: #666;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>üìä Consolidado de Asistencia</h1>
        <div class="user-menu">
            <div class="user-avatar" id="userAvatar" onclick="toggleDropdown()">
                U
            </div>
            <div class="dropdown-menu" id="dropdownMenu">
                <div class="dropdown-header" id="dropdownHeader">Administrador</div>
                <a href="/asistenciaV2r/dashboard_admin.html" class="dropdown-item">üè† Dashboard Admin</a>
                <a href="/asistenciaV2r/biometric_sync.html" class="dropdown-item">üîÑ Sincronizaci√≥n</a>
                <a href="/asistenciaV2r/procesados.html" class="dropdown-item">üìã Procesados</a>
                <a href="/asistenciaV2r/permisos.html" class="dropdown-item">üîê Permisos</a>
                <a href="/asistenciaV2r/consolidado.html" class="dropdown-item">üìä Consolidado</a>
                <a href="/asistenciaV2r/consolidado_tiempo.html" class="dropdown-item">‚è±Ô∏è Consolidado Tiempo</a>
                <a href="/asistenciaV2r/perfil.html" class="dropdown-item">üë§ Perfil</a>
                <a href="/asistenciaV2r/perfiles.html" class="dropdown-item">üë• Perfiles</a>
                <a href="/asistenciaV2r/logout" class="dropdown-item logout">üö™ Cerrar Sesi√≥n</a>
            </div>
        </div>
    </div>

    <div class="content">
        <div class="filters-section">
            <h3>Filtros de B√∫squeda</h3>
            <div class="filters-row">
                <div class="filter-group">
                    <label for="startDate">A√±o y Mes:</label>
                    <input type="month" id="startDate" name="startDate">
                </div>
                <div class="filter-group">
                    <label for="searchInput">Buscar (DNI/Nombre):</label>
                    <input type="text" id="searchInput" name="searchInput" placeholder="Ingrese DNI o nombre">
                </div>
                <button class="search-btn" onclick="loadConsolidatedData()">üîç Buscar</button>
                <button class="export-btn" onclick="exportToExcel()">üìä Exportar</button>
            </div>
        </div>

        <div class="summary-cards" id="summaryCards">
            <div class="summary-card">
                <h3 id="totalEmployees">0</h3>
                <p>Total Empleados</p>
            </div>
            <div class="summary-card">
                <h3 id="presentCount">0</h3>
                <p>Presentes</p>
            </div>
            <div class="summary-card">
                <h3 id="absentCount">0</h3>
                <p>Ausentes</p>
            </div>
            <div class="summary-card">
                <h3 id="lateCount">0</h3>
                <p>Tardanzas</p>
            </div>
        </div>

        <div class="table-container">
            <div id="consolidatedTable"></div>
            <div id="loadingMessage" class="loading">Cargando datos consolidados...</div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (window.menuManager) {
                window.menuManager.init();
            }
        });
        // Funci√≥n para mostrar/ocultar el men√∫ desplegable
        function toggleDropdown() {
            const dropdown = document.getElementById("dropdownMenu");
            dropdown.classList.toggle("show");
        }

        // Cerrar el men√∫ si se hace clic fuera de √©l
        window.onclick = function (event) {
            if (!event.target.matches('.user-avatar')) {
                const dropdowns = document.getElementsByClassName("dropdown-menu");
                for (let i = 0; i < dropdowns.length; i++) {
                    const openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        // Cargar informaci√≥n del usuario
        function loadUserInfo() {
            fetch('/asistenciaV2r/userInfo')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const avatar = document.getElementById('userAvatar');
                        const firstLetter = data.name ? data.name.charAt(0).toUpperCase() : 'U';
                        avatar.textContent = firstLetter;

                        const header = document.getElementById('dropdownHeader');
                        header.textContent = data.name || 'Usuario';
                    }
                })
                .catch(error => {
                    console.log('No se pudo cargar la informaci√≥n del usuario:', error);
                });
        }

        // Cargar datos consolidados
        function loadConsolidatedData() {
            const today = new Date();
            const y = today.getFullYear();
            const m = String(today.getMonth() + 1).padStart(2, '0');
            const startDateValue = document.getElementById('startDate').value || `${y}-${m}-01`;
            const anio = startDateValue.substring(0, 4);
            const mes = startDateValue.substring(5, 7);
            const q = document.getElementById('searchInput') ? document.getElementById('searchInput').value : '';
            const params = new URLSearchParams();
            params.append('anio', anio);
            params.append('mes', mes);
            if (q && q.trim()) params.append('q', q.trim());
            document.getElementById('loadingMessage').style.display = 'block';
            fetch(`/asistenciaV2r/api/consolidated-data?${params.toString()}`)
                .then(r => {
                    if (!r.ok) {
                        return r.text().then(t => { throw new Error('Error del servidor: ' + r.status + ' - ' + t.slice(0, 200)); });
                    }
                    return r.json();
                })
                .then(arr => {
                    document.getElementById('loadingMessage').style.display = 'none';
                    if (!Array.isArray(arr)) {
                        throw new Error('Formato de datos inv√°lido');
                    }
                    createConsolidatedTable(arr, parseInt(anio, 10), parseInt(mes, 10));
                    updateSummaryFromData(arr, parseInt(anio, 10), parseInt(mes, 10));
                })
                .catch(err => {
                    document.getElementById('loadingMessage').style.display = 'none';
                    showError('Error: ' + err.message);
                    console.error('Error cargando datos consolidados:', err);
                });
        }

        // Actualizar tarjetas de resumen
        function updateSummaryFromData(data, anio, mes) {
            let total = data.length;
            let present = 0;
            let absent = 0;
            let late = 0;
            const days = new Date(anio, mes, 0).getDate();
            for (const row of data) {
                for (let d = 1; d <= days; d++) {
                    const key = `d${String(d).padStart(2, '0')}`;
                    const v = row[key] || '';
                    if (v === 'A') present++;
                    else if (v === 'F') absent++;
                    else if (v === 'T') late++;
                }
            }
            document.getElementById('totalEmployees').textContent = total;
            document.getElementById('presentCount').textContent = present;
            document.getElementById('absentCount').textContent = absent;
            document.getElementById('lateCount').textContent = late;
        }

        // Crear tabla consolidada con SAPUI5
        function createConsolidatedTable(data, anio, mes) {
            // Limpiar contenedor anterior
            const container = document.getElementById('consolidatedTable');
            container.innerHTML = '';
            if (window.consolidatedTableUI5) {
                try { window.consolidatedTableUI5.destroy(); } catch (e) { }
                window.consolidatedTableUI5 = null;
            }

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="loading">No se encontraron datos para el per√≠odo seleccionado</div>';
                return;
            }
            if (typeof sap === 'undefined' || !sap.ui || !sap.ui.table) {
                createHTMLTable(data, anio, mes);
                return;
            }

            const oModel = new sap.ui.model.json.JSONModel();
            oModel.setData({ consolidated: data });

            const oTable = new sap.ui.table.Table({
                title: `Consolidado ${anio}-${String(mes).padStart(2, '0')} (${data.length} registros)`,
                selectionMode: sap.ui.table.SelectionMode.None,
                visibleRowCountMode: sap.ui.table.VisibleRowCountMode.Auto,
                minAutoRowCount: 10,
                enableColumnReordering: true,
                enableColumnFreeze: false,
                firstVisibleRow: 0,
                width: "100%"
            });

            // Columnas fijas
            const dniInput = new sap.m.Input({ width: "100%", placeholder: "Filtrar DNI" });
            const nomInput = new sap.m.Input({ width: "100%", placeholder: "Filtrar Nombre" });
            const applyFilters = function () {
                const filters = [];
                const vDni = dniInput.getValue().trim();
                const vNom = nomInput.getValue().trim();
                if (vDni) filters.push(new sap.ui.model.Filter("dni", sap.ui.model.FilterOperator.Contains, vDni));
                if (vNom) filters.push(new sap.ui.model.Filter("nombre", sap.ui.model.FilterOperator.Contains, vNom));
                const binding = oTable.getBinding("rows");
                if (binding) binding.filter(filters);
            };
            dniInput.attachLiveChange(applyFilters);
            nomInput.attachLiveChange(applyFilters);

            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.m.VBox({ items: [new sap.m.Text({ text: "DNI" }), dniInput] }),
                template: new sap.m.Text({ text: "{dni}" }),
                width: "140px",
                hAlign: sap.ui.core.TextAlign.Left
            }));
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.m.VBox({ items: [new sap.m.Text({ text: "Nombre" }), nomInput] }),
                template: new sap.m.Text({ text: "{nombre}" }),
                width: "260px",
                hAlign: sap.ui.core.TextAlign.Left
            }));
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.m.Label({ text: "Modalidad" }),
                template: new sap.m.Text({ text: "{modalidad}" }),
                width: "120px",
                hAlign: sap.ui.core.TextAlign.Center
            }));
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.m.Label({ text: "Cargo" }),
                template: new sap.m.Text({ text: "{cargo}" }),
                width: "200px",
                hAlign: sap.ui.core.TextAlign.Left
            }));
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.m.Label({ text: "√Årea" }),
                template: new sap.m.Text({ text: "{area}" }),
                width: "150px",
                hAlign: sap.ui.core.TextAlign.Left
            }));

            // Columnas din√°micas para cada d√≠a del mes
            const days = new Date(anio, mes, 0).getDate();
            for (let d = 1; d <= days; d++) {
                const key = `d${String(d).padStart(2, '0')}`;
                oTable.addColumn(new sap.ui.table.Column({
                    label: new sap.m.Label({ text: String(d) }),
                    template: new sap.m.Text({
                        text: `{${key}}`,
                        wrapping: false
                    }),
                    width: "55px",
                    hAlign: sap.ui.core.TextAlign.Center
                }));
            }

            oTable.setModel(oModel);
            oTable.bindRows("/consolidated");

            oTable.placeAt("consolidatedTable");
            window.consolidatedTableUI5 = oTable;
        }

        function createHTMLTable(data, anio, mes) {
            const container = document.getElementById('consolidatedTable');
            container.innerHTML = '';
            const days = new Date(anio, mes, 0).getDate();
            let html = `<div style="margin: 20px 0; font-weight: bold;">Consolidado ${anio}-${String(mes).padStart(2, '0')} (${data.length} registros)</div>`;
            html += `<div style="overflow-x:auto; max-height:600px; border:1px solid #ddd;"><table style="width:100%; border-collapse:collapse; font-size:12px;">`;
            html += `<thead><tr><th style="border:1px solid #ddd; padding:6px; min-width:100px;">DNI</th><th style="border:1px solid #ddd; padding:6px; min-width:180px;">Nombre</th><th style="border:1px solid #ddd; padding:6px; min-width:120px;">Modalidad</th><th style="border:1px solid #ddd; padding:6px; min-width:150px;">Cargo</th><th style="border:1px solid #ddd; padding:6px; min-width:120px;">√Årea</th>`;
            for (let d = 1; d <= days; d++) html += `<th style="border:1px solid #ddd; padding:4px; min-width:25px; text-align:center;">${d}</th>`;
            html += `</tr></thead><tbody>`;
            for (const row of data) {
                html += `<tr>`;
                html += `<td style="border:1px solid #ddd; padding:4px;">${row.dni || ''}</td>`;
                html += `<td style="border:1px solid #ddd; padding:4px;">${row.nombre || ''}</td>`;
                html += `<td style="border:1px solid #ddd; padding:4px;">${row.modalidad || ''}</td>`;
                html += `<td style="border:1px solid #ddd; padding:4px;">${row.cargo || ''}</td>`;
                html += `<td style="border:1px solid #ddd; padding:4px;">${row.area || ''}</td>`;
                for (let d = 1; d <= days; d++) {
                    const key = `d${String(d).padStart(2, '0')}`;
                    const v = row[key] || '';
                    let color = '';
                    if (v === 'A') color = 'background-color:#d4edda;color:#155724;';
                    else if (v === 'F') color = 'background-color:#f8d7da;color:#721c24;';
                    else if (v === 'T') color = 'background-color:#fff3cd;color:#856404;';
                    else if (v === 'NF') color = 'background-color:#e2e3e5;color:#383d41;';
                    html += `<td style="border:1px solid #ddd; padding:2px; text-align:center; ${color}">${v}</td>`;
                }
                html += `</tr>`;
            }
            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        // Exportar a Excel
        function exportToExcel() {
            const dt = document.getElementById('startDate').value || new Date().toISOString().split('T')[0];
            const anio = dt.substring(0, 4);
            const mes = dt.substring(5, 7);
            const params = new URLSearchParams();
            params.append('anio', anio);
            params.append('mes', mes);
            window.open(`/asistenciaV2r/api/consolidated-export?${params.toString()}`, '_blank');
        }

        // Mostrar error
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;

            const content = document.querySelector('.content');
            content.insertBefore(errorDiv, content.firstChild);

            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Establecer fechas por defecto (mes actual)
        function setDefaultDates() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('startDate').value = `${year}-${month}`;

            // Permitir b√∫squeda con Enter
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        loadConsolidatedData();
                    }
                });
            }
        }

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function () {
            loadUserInfo();
            setDefaultDates();
            loadConsolidatedData();
        });
    </script>
</body>

</html>