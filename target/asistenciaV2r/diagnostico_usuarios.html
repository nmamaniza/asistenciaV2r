<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de Datos - Usuarios</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .error { color: red; background: #fee; padding: 10px; border-radius: 4px; }
        .success { color: green; background: #efe; padding: 10px; border-radius: 4px; }
        .warning { color: orange; background: #ffe; padding: 10px; border-radius: 4px; }
        .data-container { max-height: 400px; overflow-y: auto; background: #f8f8f8; padding: 10px; border-radius: 4px; border: 1px solid #ccc; }
        .user-card { background: white; margin: 5px 0; padding: 10px; border-radius: 4px; border-left: 4px solid #8e44ad; }
        .field { margin: 2px 0; font-size: 12px; }
        .field strong { display: inline-block; width: 80px; }
        pre { background: #f8f8f8; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 11px; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; background: #8e44ad; color: white; cursor: pointer; }
        button:hover { background: #732d91; }
        .stats { display: flex; gap: 20px; margin: 10px 0; }
        .stat-box { background: #f0f0f0; padding: 15px; border-radius: 4px; text-align: center; }
        .stat-number { font-size: 24px; font-weight: bold; color: #8e44ad; }
        .stat-label { font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico de Datos de Usuarios</h1>
        
        <div class="section">
            <h3>1. Verificar Estructura de Datos</h3>
            <button onclick="testDataStructure()">Analizar Datos</button>
            <button onclick="testDirectAPI()">Llamada API Directa</button>
            <button onclick="clearResults()">Limpiar</button>
            <div id="structureResult"></div>
        </div>
        
        <div class="section">
            <h3>2. Muestra de Datos Crudos</h3>
            <div id="rawData" class="data-container">No hay datos a√∫n...</div>
        </div>
        
        <div class="section">
            <h3>3. An√°lisis de Campos</h3>
            <div id="fieldAnalysis"></div>
        </div>
        
        <div class="section">
            <h3>4. Verificaci√≥n de Tipos de Datos</h3>
            <div id="typeAnalysis"></div>
        </div>
        
        <div class="section">
            <h3>5. Muestra de Usuarios (Primeros 10)</h3>
            <div id="userDisplay"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue';
            console.log(`[${timestamp}] ${message}`);
        }

        function testDataStructure() {
            log('Iniciando an√°lisis de estructura de datos...');
            const resultDiv = document.getElementById('structureResult');
            resultDiv.innerHTML = '<div class="warning">Analizando datos...</div>';
            
            fetch('/asistenciaV2r/api/users', { 
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                log(`Respuesta HTTP: ${response.status} ${response.statusText}`);
                const contentType = response.headers.get('content-type');
                log(`Content-Type: ${contentType}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                if (!contentType || !contentType.includes('application/json')) {
                    return response.text().then(text => {
                        throw new Error(`Respuesta no JSON: ${text.substring(0, 300)}`);
                    });
                }
                
                return response.json();
            })
            .then(data => {
                log('Datos recibidos exitosamente', 'success');
                analyzeDataStructure(data);
            })
            .catch(error => {
                log(`Error: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            });
        }

        function testDirectAPI() {
            log('Realizando llamada API directa...');
            const resultDiv = document.getElementById('structureResult');
            resultDiv.innerHTML = '<div class="warning">Llamando API...</div>';
            
            // Test con diferentes endpoints
            const endpoints = [
                '/asistenciaV2r/api/users',
                '/asistenciaV2r/api/users?estado=1',
                '/asistenciaV2r/api/users?q=a'
            ];
            
            let results = '';
            endpoints.forEach((endpoint, index) => {
                setTimeout(() => {
                    fetch(endpoint, { credentials: 'include' })
                        .then(response => response.text())
                        .then(text => {
                            try {
                                const data = JSON.parse(text);
                                results += `<div class="success">‚úÖ ${endpoint}: ${Array.isArray(data) ? data.length + ' usuarios' : 'Datos recibidos'}</div>`;
                            } catch (e) {
                                results += `<div class="error">‚ùå ${endpoint}: Respuesta no JSON - ${text.substring(0, 100)}...</div>`;
                            }
                            if (index === endpoints.length - 1) {
                                resultDiv.innerHTML = results;
                            }
                        })
                        .catch(error => {
                            results += `<div class="error">‚ùå ${endpoint}: ${error.message}</div>`;
                            if (index === endpoints.length - 1) {
                                resultDiv.innerHTML = results;
                            }
                        });
                }, index * 500);
            });
        }

        function analyzeDataStructure(data) {
            try {
                // Mostrar datos crudos
                document.getElementById('rawData').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                
                if (!Array.isArray(data)) {
                    throw new Error(`Los datos no son un array. Tipo: ${typeof data}`);
                }
                
                const totalUsers = data.length;
                log(`Total de usuarios: ${totalUsers}`, 'success');
                
                if (totalUsers === 0) {
                    throw new Error('No hay usuarios en la base de datos');
                }
                
                // An√°lisis de campos
                const firstUser = data[0];
                const fields = Object.keys(firstUser);
                
                let fieldAnalysis = `
                    <div class="stats">
                        <div class="stat-box">
                            <div class="stat-number">${totalUsers}</div>
                            <div class="stat-label">Total Usuarios</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number">${fields.length}</div>
                            <div class="stat-label">Campos por Usuario</div>
                        </div>
                    </div>
                    <h4>Campos encontrados:</h4>
                `;
                
                fields.forEach(field => {
                    const value = firstUser[field];
                    const type = typeof value;
                    const isNull = value === null;
                    const displayValue = isNull ? 'null' : 
                                      type === 'string' ? `"${value}"` : 
                                      type === 'object' ? JSON.stringify(value) : 
                                      String(value);
                    
                    fieldAnalysis += `
                        <div class="field">
                            <strong>${field}:</strong> 
                            <span style="color: ${type === 'string' ? 'blue' : type === 'number' ? 'green' : 'red'}">
                                ${type}${isNull ? ' (null)' : ''} = ${displayValue}
                            </span>
                        </div>
                    `;
                });
                
                document.getElementById('fieldAnalysis').innerHTML = fieldAnalysis;
                
                // An√°lisis de tipos de datos
                let typeCounts = {};
                let nullCounts = {};
                
                fields.forEach(field => {
                    typeCounts[field] = {};
                    nullCounts[field] = 0;
                });
                
                data.forEach(user => {
                    fields.forEach(field => {
                        const value = user[field];
                        const type = value === null ? 'null' : typeof value;
                        
                        if (type === 'null') {
                            nullCounts[field]++;
                        } else {
                            typeCounts[field][type] = (typeCounts[field][type] || 0) + 1;
                        }
                    });
                });
                
                let typeAnalysis = '<h4>An√°lisis de tipos de datos:</h4>';
                fields.forEach(field => {
                    typeAnalysis += `<div class="field"><strong>${field}:</strong> `;
                    const types = typeCounts[field];
                    const nullCount = nullCounts[field];
                    
                    const typeInfo = [];
                    Object.keys(types).forEach(type => {
                        typeInfo.push(`${type} (${types[type]})`);
                    });
                    
                    if (nullCount > 0) {
                        typeInfo.push(`null (${nullCount})`);
                    }
                    
                    typeAnalysis += typeInfo.join(', ') + '</div>';
                });
                
                document.getElementById('typeAnalysis').innerHTML = typeAnalysis;
                
                // Mostrar primeros 10 usuarios
                let userDisplay = '<h4>Primeros 10 usuarios:</h4>';
                const sample = data.slice(0, 10);
                
                sample.forEach((user, index) => {
                    userDisplay += `
                        <div class="user-card">
                            <div class="field"><strong>Usuario ${index + 1}:</strong></div>
                            <div class="field"><strong>ID:</strong> ${user.id || 'N/A'}</div>
                            <div class="field"><strong>DNI:</strong> ${user.dni || 'N/A'}</div>
                            <div class="field"><strong>Nombre:</strong> ${user.nombre || 'N/A'}</div>
                            <div class="field"><strong>Email:</strong> ${user.email || 'N/A'}</div>
                            <div class="field"><strong>Rol:</strong> ${user.rol || 'N/A'}</div>
                            <div class="field"><strong>Estado:</strong> ${user.estado !== undefined ? user.estado : 'N/A'}</div>
                        </div>
                    `;
                });
                
                document.getElementById('userDisplay').innerHTML = userDisplay;
                
                document.getElementById('structureResult').innerHTML = `
                    <div class="success">‚úÖ An√°lisis completado exitosamente</div>
                    <div class="warning">Nota: Verifica que los campos coincidan con lo que espera SAP UI5</div>
                `;
                
                // Verificaci√≥n espec√≠fica para SAP UI5
                checkSAPUI5Compatibility(data);
                
            } catch (error) {
                log(`Error en an√°lisis: ${error.message}`, 'error');
                document.getElementById('structureResult').innerHTML = `<div class="error">‚ùå Error en an√°lisis: ${error.message}</div>`;
            }
        }
        
        function checkSAPUI5Compatibility(data) {
            if (!Array.isArray(data) || data.length === 0) return;
            
            const firstUser = data[0];
            const requiredFields = ['id', 'dni', 'nombre', 'apellidos', 'email', 'rol', 'estado'];
            const missingFields = [];
            
            requiredFields.forEach(field => {
                if (!(field in firstUser)) {
                    missingFields.push(field);
                }
            });
            
            if (missingFields.length > 0) {
                const warning = `
                    <div class="warning">
                        ‚ö†Ô∏è <strong>Campos faltantes para SAP UI5:</strong> ${missingFields.join(', ')}<br>
                        Esto podr√≠a causar problemas en la tabla.
                    </div>
                `;
                document.getElementById('structureResult').innerHTML += warning;
            } else {
                document.getElementById('structureResult').innerHTML += `
                    <div class="success">‚úÖ Todos los campos requeridos por SAP UI5 est√°n presentes</div>
                `;
            }
        }
        
        function clearResults() {
            document.getElementById('structureResult').innerHTML = '';
            document.getElementById('rawData').innerHTML = 'No hay datos a√∫n...';
            document.getElementById('fieldAnalysis').innerHTML = '';
            document.getElementById('typeAnalysis').innerHTML = '';
            document.getElementById('userDisplay').innerHTML = '';
        }
        
        // Auto-ejecutar al cargar
        window.addEventListener('load', function() {
            log('P√°gina de diagn√≥stico cargada');
            setTimeout(testDataStructure, 1000);
        });
    </script>
</body>
</html>