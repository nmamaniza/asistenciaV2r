<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Administrador - Sistema de Asistencia</title>

    <!-- OpenUI5 Library -->
    <script id="sap-ui-bootstrap" src="https://openui5.hana.ondemand.com/resources/sap-ui-core.js"
        data-sap-ui-theme="sap_fiori_3" data-sap-ui-libs="sap.m,sap.ui.core,sap.ui.table"
        data-sap-ui-compatVersion="edge" data-sap-ui-async="true">
        </script>
    <script src="/asistenciaV2r/js/menu-manager.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }

        .header {
            background-color: #8e44ad;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .admin-badge {
            background-color: #e74c3c;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }

        /* Estilos del men√∫ de usuario */
        .user-menu {
            position: relative;
            display: inline-block;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ffffff;
            color: #8e44ad;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .user-avatar:hover {
            background-color: #f0f0f0;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 220px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 5px;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-header {
            padding: 12px 16px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            font-weight: bold;
            color: #495057;
        }

        .dropdown-item {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background-color 0.3s ease;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-item.logout {
            border-top: 1px solid #e9ecef;
            color: #dc3545;
        }

        .dropdown-item.logout:hover {
            background-color: #f8d7da;
        }

        .content {
            padding: 1rem;
            max-width: 100%;
            margin: 0;
        }

        .admin-section {
            background-color: white;
            border-left: 4px solid #8e44ad;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .admin-section h3 {
            color: #8e44ad;
            margin-bottom: 15px;
        }

        .admin-section ul {
            list-style-type: none;
            padding: 0;
        }

        .admin-section li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .admin-section li:last-child {
            border-bottom: none;
        }

        .admin-section a {
            color: #8e44ad;
            text-decoration: none;
            font-weight: 500;
        }

        .admin-section a:hover {
            text-decoration: underline;
        }

        /* Estilos para el formulario de b√∫squeda */
        .search-form {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }

        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #495057;
        }

        .form-group input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #8e44ad;
            box-shadow: 0 0 0 2px rgba(142, 68, 173, 0.2);
        }

        .search-btn,
        .clear-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .search-btn {
            background-color: #8e44ad;
            color: white;
        }

        .search-btn:hover {
            background-color: #7d3c98;
        }

        .clear-btn {
            background-color: #6c757d;
            color: white;
            margin-left: 10px;
        }

        .clear-btn:hover {
            background-color: #5a6268;
        }

        /* Estilos para la tabla */
        .table-container {
            margin-top: 20px;
        }

        .loading,
        .no-data {
            text-align: center;
        }

        .admin-section ul {
            list-style-type: none;
            padding: 0;
        }

        .admin-section li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .admin-section li:last-child {
            border-bottom: none;
        }

        .admin-section a {
            color: #8e44ad;
            text-decoration: none;
            font-weight: 500;
        }

        .admin-section a:hover {
            color: #6c3483;
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="header">
        <div>
            <h1 id="pageTitle">ADMINISTRADOR</h1>
            <span class="admin-badge">ADMINISTRADOR</span>
        </div>
        <div class="user-menu">
            <div class="user-avatar" id="userAvatar" onclick="toggleDropdown()">
                A
            </div>
            <div class="dropdown-menu" id="dropdownMenu">
                <div class="dropdown-header" id="dropdownHeader">Administrador</div>

            </div>
        </div>
    </div>

    <div class="content">
        <h2>Panel de Administraci√≥n</h2>
        <p>Bienvenido al panel de administrador del Sistema de Asistencia.</p>

        <!-- Formulario de B√∫squeda de Asistencia -->
        <div class="admin-section">
            <h3>üîç B√∫squeda de Asistencia</h3>
            <div class="search-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="startDate">Fecha Inicio:</label>
                        <input type="date" id="startDate" name="startDate">
                    </div>
                    <div class="form-group">
                        <label for="endDate">Fecha Fin:</label>
                        <input type="date" id="endDate" name="endDate">
                    </div>
                    <div class="form-group">
                        <label for="userSearch">Usuario (DNI/Nombre):</label>
                        <input type="text" id="userSearch" name="userSearch" placeholder="Buscar por DNI o nombre...">
                    </div>
                    <div class="form-group">
                        <button class="search-btn" onclick="searchAttendance()">üîç Buscar</button>
                        <button class="clear-btn" onclick="clearSearch()">üóëÔ∏è Limpiar</button>
                    </div>
                </div>
            </div>

            <!-- Tabla de Resultados -->
            <div class="table-container">
                <div id="attendanceTable"></div>
                <div id="loadingMessage" class="loading" style="display: none;">Cargando datos de asistencia...</div>
                <div id="noDataMessage" class="no-data" style="display: none;">No se encontraron datos para los
                    criterios especificados.</div>
            </div>
        </div>

        <div class="admin-section">
            <h3>Funciones de Administrador:</h3>
            <ul>
                <li>Gestionar usuarios del sistema</li>
                <li>Ver reportes completos de asistencia</li>
                <li>Configurar par√°metros del sistema</li>
                <li>Exportar datos</li>
                <li>Gestionar roles y permisos</li>
            </ul>
        </div>

        <div class="admin-section">
            <h3>Acceso R√°pido:</h3>
            <ul>
                <li><a href="/asistenciaV2r/admin/users">Gesti√≥n de Usuarios</a></li>
                <li><a href="/asistenciaV2r/admin/reports">Reportes Avanzados</a></li>
                <li><a href="/asistenciaV2r/calendario.html">Calendario Laboral</a></li>
                <li><a href="/asistenciaV2r/admin/settings">Configuraci√≥n</a></li>
                <li><a href="/asistenciaV2r/biometric_sync.html">Sincronizaci√≥n Biom√©trica</a></li>
                <li><a href="/asistenciaV2r/dashboard.html">Vista de Usuario</a></li>
            </ul>
        </div>
    </div>

    <script>
        // Funci√≥n para mostrar/ocultar el men√∫ desplegable
        function toggleDropdown() {
            const dropdown = document.getElementById("dropdownMenu");
            dropdown.classList.toggle("show");
        }

        // Cerrar el men√∫ si se hace clic fuera de √©l
        window.onclick = function (event) {
            if (!event.target.matches('.user-avatar')) {
                const dropdowns = document.getElementsByClassName("dropdown-menu");
                for (let i = 0; i < dropdowns.length; i++) {
                    const openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        // Cargar informaci√≥n del usuario
        function loadUserInfo() {
            // Usar la API correcta dentro del contexto
            fetch('./api/userInfo')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(text => {
                    try {
                        const data = JSON.parse(text);
                        if (data.success) {
                            const fullName = [data.nombre, data.apellidos].filter(Boolean).join(' ').trim();
                            const nameForDisplay = fullName || data.nombre || 'Administrador';

                            // Actualizar avatar con la primera letra del nombre
                            const avatar = document.getElementById('userAvatar');
                            const firstLetter = nameForDisplay.charAt(0).toUpperCase();
                            avatar.textContent = firstLetter || 'A';

                            // Actualizar header del dropdown
                            const header = document.getElementById('dropdownHeader');
                            header.textContent = nameForDisplay;

                            // Actualizar t√≠tulo principal con ADMINISTRADOR y el nombre
                            const pageTitle = document.getElementById('pageTitle');
                            if (pageTitle) {
                                pageTitle.textContent = `ADMINISTRADOR - ${nameForDisplay}`;
                            }
                        } else {
                            // Si la respuesta no tiene √©xito, establecer valores por defecto
                            setDefaultUserInfo();
                        }
                    } catch (e) {
                        console.error('Error al parsear JSON:', e);
                        // Establecer valores por defecto
                        setDefaultUserInfo();
                    }
                })
                .catch(error => {
                    console.error('No se pudo cargar la informaci√≥n del usuario:', error);
                    // Intentar con una URL alternativa si la primera falla (absoluta al contexto)
                    fetch('/asistenciaV2r/api/userInfo')
                        .then(response => response.text())
                        .then(text => {
                            try {
                                const data = JSON.parse(text);
                                if (data.success) {
                                    const fullName = [data.nombre, data.apellidos].filter(Boolean).join(' ').trim();
                                    const nameForDisplay = fullName || data.nombre || 'Administrador';

                                    const avatar = document.getElementById('userAvatar');
                                    const firstLetter = nameForDisplay.charAt(0).toUpperCase();
                                    avatar.textContent = firstLetter || 'A';

                                    const header = document.getElementById('dropdownHeader');
                                    header.textContent = nameForDisplay;

                                    // Actualizar t√≠tulo principal tambi√©n en esta ruta
                                    const pageTitle = document.getElementById('pageTitle');
                                    if (pageTitle) {
                                        pageTitle.textContent = `ADMINISTRADOR - ${nameForDisplay}`;
                                    }
                                } else {
                                    setDefaultUserInfo();
                                }
                            } catch (e) {
                                setDefaultUserInfo();
                            }
                        })
                        .catch(error => {
                            console.error('No se pudo cargar la informaci√≥n del usuario con URL alternativa:', error);
                            setDefaultUserInfo();
                        });
                });
        }

        // Funci√≥n auxiliar para establecer valores por defecto
        function setDefaultUserInfo() {
            document.getElementById('userAvatar').textContent = 'A';
            document.getElementById('dropdownHeader').textContent = 'Administrador';
            const pageTitle = document.getElementById('pageTitle');
            if (pageTitle) {
                pageTitle.textContent = 'ADMINISTRADOR';
            }
        }

        // Cargar informaci√≥n del usuario al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function () {
            loadUserInfo();
            setDefaultDates();

            if (window.menuManager) {
                window.menuManager.init();
            }

            sap.ui.getCore().attachInit(function () {
                console.log("OpenUI5 inicializado correctamente");
            });
        });

        // Funci√≥n para establecer fechas por defecto (√∫ltimo mes)
        function setDefaultDates() {
            const today = new Date();
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
            const fmt = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            // Usar formato local en vez de toISOString para evitar desfase
            document.getElementById('startDate').value = fmt(lastMonth);
            document.getElementById('endDate').value = fmt(today);
        }

        // Funci√≥n para buscar asistencia usando OpenUI5
        function searchAttendance() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const userSearch = document.getElementById('userSearch').value.trim();

            console.log('Iniciando b√∫squeda con par√°metros:', {
                startDate: startDate,
                endDate: endDate,
                userSearch: userSearch
            });

            if (!startDate || !endDate) {
                sap.m.MessageToast.show('Por favor, seleccione las fechas de inicio y fin.');
                return;
            }

            // Comparar fechas como locales (YYYY-MM-DD) sin interpretaci√≥n UTC
            const parseLocal = (str) => {
                const m = str.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})$/);
                if (!m) return null;
                const y = parseInt(m[1], 10);
                const mo = parseInt(m[2], 10);
                const d = parseInt(m[3], 10);
                return new Date(y, mo - 1, d);
            };
            const startLocal = parseLocal(startDate);
            const endLocal = parseLocal(endDate);
            if (startLocal && endLocal && startLocal > endLocal) {
                sap.m.MessageToast.show('La fecha de inicio no puede ser mayor que la fecha de fin.');
                return;
            }

            showLoading(true);

            // Construir los par√°metros de b√∫squeda
            const params = new URLSearchParams();

            // Convertir fechas a formato yyyy-MM-dd para el backend (parseo local)
            const startDateObj = startLocal || new Date(startDate);
            const endDateObj = endLocal || new Date(endDate);
            // Ajustar fin de d√≠a para cubrir todo el rango (en horario local)
            endDateObj.setHours(23, 59, 59, 999);

            // Formatear fechas en formato yyyy-MM-dd (local)
            const formatDateLocal = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            params.append('startDate', formatDateLocal(startDateObj));
            params.append('endDate', formatDateLocal(endDateObj));
            // Enviar tambi√©n timestamps por compatibilidad backend
            params.append('startTimestamp', startDateObj.getTime().toString());
            params.append('endTimestamp', endDateObj.getTime().toString());

            // Solo agregar el par√°metro user si hay algo para buscar
            if (userSearch) {
                params.append('user', userSearch);
                // Detectar si es DNI (solo n√∫meros) o Nombre (texto)
                const isNumeric = /^[0-9]+$/.test(userSearch);
                if (isNumeric) {
                    params.append('dni', userSearch);
                } else {
                    params.append('nombre', userSearch);
                }
            }

            const url = `/asistenciaV2r/searchAttendance?${params.toString()}`;
            console.log('URL de b√∫squeda:', url);

            // Usar el modelo de OpenUI5 para la b√∫squeda
            const busyDialog = new sap.m.BusyDialog({
                title: "Buscando",
                text: "Obteniendo datos de asistencia...",
                showCancelButton: false
            });

            busyDialog.open();

            fetch(url)
                .then(response => {
                    console.log('Respuesta del servidor:', response.status, response.statusText);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Datos recibidos:', data);
                    // Imprimir los datos completos para depuraci√≥n
                    console.log('Datos completos:', JSON.stringify(data));
                    busyDialog.close();
                    showLoading(false);

                    // Verificar si los datos son un array (respuesta directa del endpoint attendanceList)
                    if (Array.isArray(data)) {
                        if (data.length > 0) {
                            // Asegurar que el campo mensaje est√© disponible en cada registro
                            data.forEach(item => {
                                console.log('Registro original:', item);
                            });
                            createAttendanceTable(data);
                            sap.m.MessageToast.show(`Se encontraron ${data.length} registros`);
                        } else {
                            showNoData(true);
                            sap.m.MessageToast.show('No se encontraron registros de asistencia');
                        }
                    }
                    // Verificar si es un objeto con propiedad success (formato anterior)
                    else if (data.success) {
                        if (data.attendances && data.attendances.length > 0) {
                            createAttendanceTable(data.attendances);
                            sap.m.MessageToast.show(`Se encontraron ${data.attendances.length} registros`);
                        } else {
                            showNoData(true);
                            sap.m.MessageToast.show('No se encontraron registros de asistencia');
                        }
                    } else {
                        showNoData(true);
                        console.error('Error al buscar asistencia:', data.message);
                        alert('Error: ' + (data.message || 'Error desconocido'));
                    }
                })
                .catch(error => {
                    console.error('Error en la b√∫squeda:', error);
                    busyDialog.close();
                    showLoading(false);
                    showNoData(true);
                    alert('Error de conexi√≥n: ' + error.message);
                });
        }

        // Funci√≥n para crear la tabla de asistencia con OpenUI5
        function createAttendanceTable(attendances) {
            showNoData(false);

            if (!attendances || attendances.length === 0) {
                showNoData(true);
                return;
            }

            // Formatear fechas para mejor visualizaci√≥n
            attendances.forEach(item => {
                if (item.fechahora) {
                    let fechaHora;
                    if (typeof item.fechahora === 'number') {
                        fechaHora = new Date(item.fechahora);
                    } else if (typeof item.fechahora === 'string' && /^\d+$/.test(item.fechahora)) {
                        fechaHora = new Date(parseInt(item.fechahora));
                    } else {
                        fechaHora = new Date(item.fechahora);
                    }
                    if (!isNaN(fechaHora.getTime())) {
                        item.fechahoraFormatted = fechaHora.toLocaleString('es-ES');
                    } else {
                        item.fechahoraFormatted = item.fechahora;
                    }
                }
                if (item.fecha) {
                    // Formatear fecha evitando desfase por zona horaria cuando viene como 'YYYY-MM-DD'
                    if (typeof item.fecha === 'string') {
                        const isoMatch = item.fecha.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})$/);
                        if (isoMatch) {
                            const y = parseInt(isoMatch[1], 10);
                            const m = parseInt(isoMatch[2], 10);
                            const d = parseInt(isoMatch[3], 10);
                            // Construir fecha local (no UTC) para evitar retroceso de d√≠a
                            const fechaLocal = new Date(y, m - 1, d);
                            if (!isNaN(fechaLocal.getTime())) {
                                item.fechaFormatted = `${String(d).padStart(2, '0')}/${String(m).padStart(2, '0')}/${y}`;
                            } else {
                                item.fechaFormatted = item.fecha;
                            }
                        } else if (/^\d+$/.test(item.fecha)) {
                            const fechaDate = new Date(parseInt(item.fecha));
                            item.fechaFormatted = !isNaN(fechaDate.getTime()) ? fechaDate.toLocaleDateString('es-ES') : item.fecha;
                        } else {
                            // Para strings no ISO, intentar parseo est√°ndar
                            const fechaDate = new Date(item.fecha);
                            item.fechaFormatted = !isNaN(fechaDate.getTime()) ? fechaDate.toLocaleDateString('es-ES') : item.fecha;
                        }
                    } else if (typeof item.fecha === 'number') {
                        const fechaDate = new Date(item.fecha);
                        item.fechaFormatted = !isNaN(fechaDate.getTime()) ? fechaDate.toLocaleDateString('es-ES') : item.fecha;
                    } else {
                        item.fechaFormatted = item.fecha;
                    }
                }
                if (item.hora) {
                    item.horaFormatted = item.hora;
                }
                // Asegurar que el campo mensaje est√© disponible y visible
                let msg = (item.mensaje !== undefined && item.mensaje !== null) ? item.mensaje : (item.message || "");
                if (typeof msg === 'string') {
                    const lower = msg.toLowerCase();
                    if (lower === 'null' || lower === 'undefined') {
                        msg = "";
                    }
                } else {
                    msg = "";
                }
                item.mensaje = msg;
                if (item.tipo_marcaje == null) {
                    item.tipo_marcaje = "";
                } else if (typeof item.tipo_marcaje === 'string') {
                    const t = item.tipo_marcaje.trim().toLowerCase();
                    if (t === '' || t === 'null' || t === 'undefined') {
                        item.tipo_marcaje = "";
                    }
                }

                // Imprimir para depuraci√≥n
                console.log("Registro procesado:", {
                    dni: item.dni,
                    nombre: item.nombre,
                    fechahora: item.fechahora,
                    fechahoraFormatted: item.fechahoraFormatted,
                    fecha: item.fecha,
                    fechaFormatted: item.fechaFormatted,
                    hora: item.hora,
                    horaFormatted: item.horaFormatted,
                    reloj: item.reloj,
                    tipo_marcaje: item.tipo_marcaje,
                    mensaje: item.mensaje
                });
            });

            // Limpiar contenedor y destruir componentes UI5 existentes
            const container = document.getElementById('attendanceTable');
            container.innerHTML = '';

            // Destruir tabla existente si existe
            if (window.attendanceTableUI5) {
                window.attendanceTableUI5.destroy();
                window.attendanceTableUI5 = null;
            }

            // Crear modelo de datos
            const oModel = new sap.ui.model.json.JSONModel({
                attendances: attendances
            });

            // Crear tabla
            const oTable = new sap.m.Table({
                id: "attendanceTableUI5",
                headerText: `Registros de Asistencia (${attendances.length} registros)`,
                mode: sap.m.ListMode.None,
                growing: true,
                growingThreshold: 50,
                columns: [
                    new sap.m.Column({
                        header: new sap.m.Text({ text: "DNI" }),
                        width: "100px"
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({ text: "Nombre" }),
                        width: "200px"
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({ text: "Fecha y Hora" }),
                        width: "150px"
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({ text: "Fecha" }),
                        width: "120px"
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({ text: "Hora" }),
                        width: "120px"
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({ text: "Reloj" }),
                        width: "100px"
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({ text: "Tipo Marcaje" }),
                        width: "120px"
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({ text: "Mensaje" }),
                        width: "200px",
                        minScreenWidth: "Tablet"
                    })
                ]
            });

            // Template para las filas
            const oTemplate = new sap.m.ColumnListItem({
                cells: [
                    new sap.m.Text({ text: "{dni}" }),
                    new sap.m.Text({ text: "{nombre}" }),
                    new sap.m.Text({ text: "{fechahoraFormatted}" }),
                    new sap.m.Text({ text: "{fechaFormatted}" }),
                    new sap.m.Text({ text: "{horaFormatted}" }),
                    new sap.m.Text({ text: "{reloj}" }),
                    new sap.m.Text({ text: "{tipo_marcaje}" }),
                    new sap.m.Text({ text: "{mensaje}" })
                ]
            });

            // Vincular datos
            oTable.setModel(oModel);
            oTable.bindItems("/attendances", oTemplate);

            // Agregar tabla al contenedor
            oTable.placeAt(container);

            // Guardar referencia a la tabla para poder destruirla despu√©s
            window.attendanceTableUI5 = oTable;
        }

        // Funci√≥n para limpiar b√∫squeda
        function clearSearch() {
            document.getElementById('userSearch').value = '';
            document.getElementById('attendanceTable').innerHTML = '';
            showNoData(false);
            setDefaultDates();
        }

        // Funciones auxiliares para mostrar/ocultar mensajes
        function showLoading(show) {
            document.getElementById('loadingMessage').style.display = show ? 'block' : 'none';
        }

        function showNoData(show) {
            document.getElementById('noDataMessage').style.display = show ? 'block' : 'none';
        }

        // Cargar marcaciones del usuario actual
        function loadUserAttendanceData() {
            console.log('Cargando datos de marcaciones del usuario...');
            showLoading(true);

            // Limpiar el contenedor antes de cargar nuevos datos
            document.getElementById('userAttendanceTable').innerHTML = '';

            // Destruir componentes UI5 existentes si existen
            try {
                const existingTable = sap.ui.getCore().byId("userAttendanceTableUI5");
                if (existingTable) {
                    existingTable.destroy();
                }

                const existingPanel = sap.ui.getCore().byId("userAttendancePanel");
                if (existingPanel) {
                    existingPanel.destroy();
                }
            } catch (e) {
                console.log("No hay componentes UI5 para destruir o ya fueron destruidos");
            }

            fetch('./api/attendances')
                .then(response => {
                    if (response.status === 401) {
                        return [];
                    }
                    if (!response.ok) {
                        throw new Error('Error al cargar datos: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Datos de marcaciones recibidos:', data);
                    showLoading(false);

                    if (!data || data.length === 0) {
                        document.getElementById('userAttendanceTable').innerHTML = '<div class="alert alert-info">No hay marcaciones disponibles</div>';
                        return;
                    }

                    // Formatear fechas para mejor visualizaci√≥n
                    if (Array.isArray(data)) {
                        data.forEach(item => {
                            if (item.fechahora) {
                                item.fechahoraFormatted = new Date(item.fechahora).toLocaleString('es-ES');
                            }
                            if (item.fecha) {
                                if (typeof item.fecha === 'string') {
                                    const isoMatch = item.fecha.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})$/);
                                    if (isoMatch) {
                                        const y = parseInt(isoMatch[1], 10);
                                        const m = parseInt(isoMatch[2], 10);
                                        const d = parseInt(isoMatch[3], 10);
                                        const fechaLocal = new Date(y, m - 1, d);
                                        item.fechaFormatted = `${String(d).padStart(2, '0')}/${String(m).padStart(2, '0')}/${y}`;
                                    } else if (/^\d+$/.test(item.fecha)) {
                                        const fechaDate = new Date(parseInt(item.fecha));
                                        item.fechaFormatted = !isNaN(fechaDate.getTime()) ? fechaDate.toLocaleDateString('es-ES') : item.fecha;
                                    } else {
                                        const fechaDate = new Date(item.fecha);
                                        item.fechaFormatted = !isNaN(fechaDate.getTime()) ? fechaDate.toLocaleDateString('es-ES') : item.fecha;
                                    }
                                } else if (typeof item.fecha === 'number') {
                                    const fechaDate = new Date(item.fecha);
                                    item.fechaFormatted = !isNaN(fechaDate.getTime()) ? fechaDate.toLocaleDateString('es-ES') : item.fecha;
                                } else {
                                    item.fechaFormatted = item.fecha;
                                }
                            }
                            if (item.hora) {
                                item.horaFormatted = item.hora;
                            }
                            // Asegurar que el campo mensaje est√© disponible y visible
                            let msg = (item.mensaje !== undefined && item.mensaje !== null) ? item.mensaje : (item.message || "");
                            if (typeof msg === 'string') {
                                const lower = msg.toLowerCase();
                                if (lower === 'null' || lower === 'undefined') {
                                    msg = "";
                                }
                            } else {
                                msg = "";
                            }
                            item.mensaje = msg;
                            // Asegurar que el campo tipo_marcaje est√© disponible
                            if (!item.tipo_marcaje || item.tipo_marcaje === "null" || item.tipo_marcaje === "undefined" || item.tipo_marcaje === null || item.tipo_marcaje === undefined) {
                                item.tipo_marcaje = "";
                            }
                        });
                    }

                    renderUserAttendanceTable(data);
                })
                .catch(error => {
                    console.error('Error al cargar datos de marcaciones:', error);
                    showLoading(false);
                    document.getElementById('userAttendanceTable').innerHTML =
                        '<div class="alert alert-danger">Error al cargar las marcaciones: ' + error.message + '</div>';
                });
        }

        // Renderizar tabla de marcaciones del usuario
        function renderUserAttendanceTable(attendances) {
            // Limpiar contenedor
            const container = document.getElementById('userAttendanceTable');
            container.innerHTML = '';

            // Crear modelo de datos para OpenUI5
            const oModel = new sap.ui.model.json.JSONModel({
                attendances: attendances
            });

            // Crear tabla
            const oTable = new sap.m.Table("userAttendanceTableUI5", {
                headerText: `Mis Marcaciones (${attendances.length} registros)`,
                mode: sap.m.ListMode.None,
                growing: true,
                growingThreshold: 10,
                columns: [
                    new sap.m.Column({
                        header: new sap.m.Text({ text: "DNI" }),
                        width: "100px"
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({ text: "Nombre" }),
                        width: "200px"
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({ text: "Fecha y Hora" }),
                        width: "150px"
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({ text: "Fecha" }),
                        width: "100px"
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({ text: "Hora" }),
                        width: "80px"
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({ text: "Reloj" }),
                        width: "80px"
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({ text: "Tipo Marcaje" }),
                        width: "120px"
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({ text: "Mensaje" }),
                        width: "200px",
                        minScreenWidth: "Tablet"
                    })
                ]
            });

            // Template para las filas
            const oTemplate = new sap.m.ColumnListItem({
                cells: [
                    new sap.m.Text({ text: "{dni}" }),
                    new sap.m.Text({ text: "{nombre}" }),
                    new sap.m.Text({ text: "{fechahoraFormatted}" }),
                    new sap.m.Text({ text: "{fechaFormatted}" }),
                    new sap.m.Text({ text: "{horaFormatted}" }),
                    new sap.m.Text({ text: "{reloj}" }),
                    new sap.m.Text({ text: "{tipo_marcaje}" }),
                    new sap.m.Text({ text: "{mensaje}" })
                ]
            });

            // Vincular datos
            oTable.setModel(oModel);
            oTable.bindItems("/attendances", oTemplate);

            // Bot√≥n para actualizar datos
            const oRefreshButton = new sap.m.Button({
                text: "Actualizar Mis Marcaciones",
                type: "Emphasized",
                press: function () {
                    // Destruir la tabla existente antes de cargar nuevos datos
                    const existingTable = sap.ui.getCore().byId("userAttendanceTableUI5");
                    if (existingTable) {
                        existingTable.destroy();
                    }
                    loadUserAttendanceData();
                }
            });

            // Crear panel para contener todo
            const oPanel = new sap.m.Panel("userAttendancePanel", {
                headerText: "Mis Marcaciones",
                expandable: true,
                expanded: true,
                width: "100%",
                content: [
                    new sap.m.Toolbar({
                        content: [
                            new sap.m.ToolbarSpacer(),
                            oRefreshButton
                        ]
                    }),
                    oTable
                ]
            });

            // Ya no necesitamos destruir el panel aqu√≠ porque lo hacemos en loadUserAttendanceData
            // Esto evita el error "The object with ID userAttendancePanel was destroyed and cannot be used anymore"

            // Agregar panel al contenedor
            oPanel.placeAt(container);
        }

        // Cargar marcaciones del usuario al iniciar
        document.addEventListener('DOMContentLoaded', function () {
            // Cargar las marcaciones del usuario despu√©s de que se cargue la p√°gina
            setTimeout(loadUserAttendanceData, 1000);
        });
    </script>

    <!-- Contenedor para las marcaciones del usuario -->
    <div class="content">
        <div class="admin-section">
            <h3>Mis Marcaciones</h3>
            <div id="userAttendanceTable"></div>
        </div>
    </div>
</body>

</html>