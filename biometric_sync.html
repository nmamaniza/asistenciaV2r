<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sincronizaci贸n Biom茅trica - AsistenciaV2</title>
    <script src="https://openui5.hana.ondemand.com/resources/sap-ui-core.js"
            data-sap-ui-libs="sap.m,sap.ui.core"
            data-sap-ui-theme="sap_horizon"
            data-sap-ui-resourceroots='{
                "biometric": "./"
            }'></script>
    <script src="/asistenciaV2r/js/menu-manager.js"></script>
    <style>
        .sync-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .results-panel {
            display: block;
            position: static;
            background: transparent;
            margin-top: 20px;
        }
        .results-content {
            background: #fff;
            margin: 0;
            max-width: 100%;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        #terminalOutput {
            background: #ffffff;
            color: #333333;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            max-height: 400px;
            overflow: auto;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 13px;
            line-height: 1.5;
        }
        .device-card {
            margin: 10px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #0070f3;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        .sync-button {
            background-color: #0070f3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .sync-button:hover {
            background-color: #0051a2;
        }
        .sync-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .error {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #2e7d32;
            background-color: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .user-menu { position: relative; display: inline-block; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: #ffffff; color: #0070f3; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; }
        .user-avatar:hover { background-color: #f0f0f0; }
        .dropdown-menu { display: none; position: absolute; right: 0; background: #fff; min-width: 220px; box-shadow: 0px 8px 16px rgba(0,0,0,0.2); z-index: 1000; border-radius: 8px; overflow: hidden; margin-top: 5px; }
        .dropdown-menu.show { display: block; }
        .dropdown-header { padding: 12px 16px; background: #f8f9fa; border-bottom: 1px solid #e9ecef; font-weight: bold; color: #495057; }
        .dropdown-item { color: #333; padding: 12px 16px; text-decoration: none; display: block; }
        .dropdown-item:hover { background-color: #f8f9fa; }
        .dropdown-item.logout { border-top: 1px solid #e9ecef; color: #dc3545; }
        .dropdown-item.logout:hover { background-color: #f8d7da; }
    </style>
</head>
<body>
    <div class="header" style="background:#0070f3;color:#fff;padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 4px rgba(0,0,0,0.1)">
        <h1 style="margin:0;font-size:1.5rem">Sincronizaci贸n Biom茅trica</h1>
        <div class="user-menu">
            <div class="user-avatar" id="userAvatar" onclick="toggleDropdown()">U</div>
            <div class="dropdown-menu" id="dropdownMenu">
                <div class="dropdown-header" id="dropdownHeader">Administrador</div>
                <a href="/asistenciaV2r/dashboard_admin.html" class="dropdown-item"> Dashboard Admin</a>
                <a href="/asistenciaV2r/biometric_sync.html" class="dropdown-item"> Sincronizaci贸n</a>
                <a href="/asistenciaV2r/procesados.html" class="dropdown-item"> Procesados</a>
                <a href="/asistenciaV2r/permisos.html" class="dropdown-item"> Permisos</a>
                <a href="/asistenciaV2r/consolidado.html" class="dropdown-item"> Consolidado</a>
                <a href="/asistenciaV2r/perfiles.html" class="dropdown-item"> Perfiles</a>
                <a href="/asistenciaV2r/logout" class="dropdown-item logout"> Cerrar Sesi贸n</a>
            </div>
        </div>
    </div>

    <div class="sync-container">
        <div class="sapUiMediumMargin">
            <div class="sapUiMediumMarginBottom">
                <button id="syncButton" class="sync-button" onclick="startSync()">Iniciar Sincronizaci贸n</button>
                <button class="sync-button" onclick="window.location.href='/asistenciaV2r/dashboard_admin.html'">Volver al Dashboard</button>
            </div>
            
            
            
            <div id="messages"></div>

            <div id="resultsPanel" class="results-panel">
                <div class="results-content">
                    <h3>Resultados de sincronizaci贸n</h3>
                    <div id="liveStatus"></div>
                    <pre id="terminalOutput"></pre>
                    
                </div>
            </div>
            
            <div id="globalStats" class="stats-grid" style="display: none;">
                <div class="stat-card">
                    <div id="totalRecords" class="stat-number">0</div>
                    <div class="stat-label">Total Registros</div>
                </div>
                <div class="stat-card">
                    <div id="newRecords" class="stat-number">0</div>
                    <div class="stat-label">Nuevos Registros</div>
                </div>
                <div class="stat-card">
                    <div id="duplicates" class="stat-number">0</div>
                    <div class="stat-label">Duplicados</div>
                </div>
                <div class="stat-card">
                    <div id="errors" class="stat-number">0</div>
                    <div class="stat-label">Errores</div>
                </div>
            </div>
            
            <div id="deviceResults"></div>
            
            <div id="attendanceTable" style="margin-top: 30px;"></div>
        </div>
    </div>
    
    <script>
        let oTable;
        let syncES;
        let rawBuffer = '';
        
        sap.ui.getCore().attachInit(function() {
            initializeTable();
            getStatus();
            if (window.menuManager) {
                window.menuManager.init();
            }
        });
        
        function initializeTable() {
            // Crear tabla para mostrar registros de asistencia
            oTable = new sap.m.Table("attendanceTableControl", {
                headerText: "ltimos Registros Sincronizados",
                mode: sap.m.ListMode.None,
                columns: [
                    new sap.m.Column({
                        header: new sap.m.Text({text: "DNI"})
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Nombre"})
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Fecha y Hora"})
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Reloj"})
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Tipo Marcaje"})
                    })
                ]
            });
            
            oTable.placeAt("attendanceTable");
            loadAttendanceData();
        }
        
        function startSync() {
            const syncButton = document.getElementById('syncButton');
            const messages = document.getElementById('messages');
            
            syncButton.disabled = true;
            messages.innerHTML = '';
            const pre = document.getElementById('terminalOutput');
            pre.textContent += 'Ejecutando sync_checker.py...\n';
            fetch('/asistenciaV2r/api/biometric-sync?action=startScript', { credentials: 'include' })
                .then(r => r.json())
                .then(data => {
                    if (syncES) { try { syncES.close(); } catch(e) {} }
                    rawBuffer = '';
                    const statusDiv = document.getElementById('liveStatus');
                    statusDiv.innerHTML = '';
                    syncES = new EventSource('/asistenciaV2r/api/biometric-sync?action=stream');
                    let pending = [];
                    let flushScheduled = false;
                    function flushBatch() {
                        if (!pending.length) { flushScheduled = false; return; }
                        const text = pending.join('\n');
                        rawBuffer += text + '\n';
                        pre.textContent += sanitizeLine(text) + '\n';
                        updateResultsFromOutput(rawBuffer);
                        pending = [];
                        flushScheduled = false;
                        // mantener scroll pegado al final
                        pre.scrollTop = pre.scrollHeight;
                    }
                    syncES.onmessage = (ev) => {
                        if (ev && ev.data) {
                            const line = ev.data;
                            if (line && line.indexOf('"type":"end"') !== -1) {
                                try { syncES.close(); } catch(e) {}
                                const syncButton = document.getElementById('syncButton');
                                if (syncButton) syncButton.disabled = false;
                                loadAttendanceData();
                                // vaciar lo pendiente
                                flushBatch();
                                return;
                            }
                            pending.push(line);
                            if (!flushScheduled) {
                                flushScheduled = true;
                                setTimeout(flushBatch, 200);
                            }
                        }
                    };
                    syncES.onerror = () => {
                        try { syncES.close(); } catch(e) {}
                        const syncButton = document.getElementById('syncButton');
                        if (syncButton) syncButton.disabled = false;
                    };
                    if (!data.success) {
                        showMessage(data.message || 'Proceso en ejecuci贸n', 'warning');
                    }
                })
                .catch(err => {
                    syncButton.disabled = false;
                    pre.textContent += 'Error: ' + err.message + '\n';
                });
        }

        

        

        function updateResultsFromOutput(text) {
            const pre = document.getElementById('terminalOutput');
            const statusDiv = document.getElementById('liveStatus');
            pre.scrollTop = pre.scrollHeight;
            if (!text || !text.trim()) {
                statusDiv.innerHTML = '<div class="device-card"><p>No se recibi贸 salida del proceso.</p></div>';
                return;
            }
            // procesar solo el fragmento reciente para evitar O(N) total cada vez
            const lines = (text || '').split(/\r?\n/);
            const recent = lines.slice(Math.max(0, lines.length - 200));
            parseAndRenderSummaryFromText(recent.join('\n'));
            const clocks = {};
            recent.forEach(line => parseLogLineForDeviceStatus(line, clocks));
            if (Object.keys(clocks).length > 0) {
                renderLiveStatus(clocks);
            } else {
                const preview = recent.slice(-10).join('\n');
                statusDiv.innerHTML = `<div class="device-card"><h4>Salida del proceso</h4><pre style="white-space:pre-wrap">${preview}</pre></div>`;
            }
        }

        async function stopBackground() {
            const stopBtn = document.getElementById('stopBgButton');
            stopBtn.disabled = true;
            try {
                const resp = await fetch('/asistenciaV2r/api/biometric-sync?action=stopScript', { credentials: 'include' });
                if (!resp.ok) throw new Error('No se pudo detener el proceso');
                const data = await resp.json();
                showMessage(data.message || 'Proceso detenido', data.success ? 'info' : 'warning');
            } catch (err) {
                showMessage('Error: ' + err.message, 'danger');
            } finally {
                if (syncES) { try { syncES.close(); } catch(e) {} }
                const syncButton = document.getElementById('syncButton');
                if (syncButton) syncButton.disabled = false;
                getStatus();
            }
        }

        function showResultsPanel() {
            const pre = document.getElementById('terminalOutput');
            const status = document.getElementById('liveStatus');
            pre.textContent = '';
            status.innerHTML = '';
        }
        function toggleDropdown() {
            var dropdown = document.getElementById('dropdownMenu');
            dropdown.classList.toggle('show');
        }
        window.onclick = function(event) {
            if (!event.target.matches('.user-avatar')) {
                var dropdowns = document.getElementsByClassName('dropdown-menu');
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    openDropdown.classList.remove('show');
                }
            }
        }
        
        function getStatus() {
            fetch('/asistenciaV2r/api/biometric-sync?action=status', { credentials: 'include' })
            .then(response => response.json())
            .then(data => {
                const stopBtn = document.getElementById('stopBgButton');
                const syncButton = document.getElementById('syncButton');
                if (stopBtn) stopBtn.disabled = !data.running;
                if (syncButton) syncButton.disabled = !!data.running;
            })
            .catch(error => {
                showMessage('Error obteniendo estado: ' + error.message, 'error');
            });
        }
        
        function displayResults(data) {
            // Mostrar estad铆sticas globales
            document.getElementById('totalRecords').textContent = data.totalRecords || 0;
            document.getElementById('newRecords').textContent = data.newRecords || 0;
            document.getElementById('duplicates').textContent = data.duplicates || 0;
            document.getElementById('errors').textContent = data.errors || 0;
            document.getElementById('globalStats').style.display = 'grid';
            
            // Mostrar resultados por dispositivo
            const deviceResults = document.getElementById('deviceResults');
            deviceResults.innerHTML = '<h3>Resultados por Dispositivo:</h3>';
            
            if (data.deviceResults) {
                data.deviceResults.forEach(device => {
                    const deviceCard = document.createElement('div');
                    deviceCard.className = 'device-card';
                    deviceCard.innerHTML = `
                        <h4>Dispositivo: ${device.deviceId} (${device.ip})</h4>
                        <p><strong>Total registros:</strong> ${device.stats.totalRecords}</p>
                        <p><strong>Nuevos registros:</strong> ${device.stats.newRecords}</p>
                        <p><strong>Duplicados:</strong> ${device.stats.duplicates}</p>
                        <p><strong>Errores:</strong> ${device.stats.errors}</p>
                        ${device.stats.lastRecord ? `
                            <p><strong>ltimo registro:</strong> ${device.stats.lastRecord.dni} - ${device.stats.lastRecord.nombre} - ${device.stats.lastRecord.fechahora}</p>
                        ` : ''}
                    `;
                    deviceResults.appendChild(deviceCard);
                });
            }
        }
        
        function displayDeviceStatus(data) { return; }
        
        function loadAttendanceData() {
            fetch('/asistenciaV2r/searchAttendance', { credentials: 'include' })
            .then(response => response.json())
            .then(raw => {
                const data = Array.isArray(raw) ? raw.slice(0, 20).map(item => {
                    let tipo = item ? item.tipo_marcaje : null;
                    if (tipo == null) {
                        tipo = '';
                    } else if (typeof tipo === 'string') {
                        const t = tipo.trim().toLowerCase();
                        if (t === '' || t === 'null' || t === 'undefined') {
                            tipo = '';
                        }
                    }
                    const out = {
                        dni: item.dni,
                        nombre: item.nombre,
                        reloj: item.reloj,
                        tipo_marcaje: tipo,
                        fechahora: ''
                    };
                    try {
                        if (typeof item.fechahora === 'number') {
                            out.fechahora = new Date(item.fechahora).toLocaleString('es-PE');
                        } else if (typeof item.fechahora === 'string' && /^\d+$/.test(item.fechahora)) {
                            out.fechahora = new Date(parseInt(item.fechahora)).toLocaleString('es-PE');
                        } else if (item.fechahora) {
                            out.fechahora = new Date(item.fechahora).toLocaleString('es-PE');
                        }
                    } catch(e) {
                        out.fechahora = item.fechahora || '';
                    }
                    return out;
                }) : [];
                if (oTable) {
                    const oModel = new sap.ui.model.json.JSONModel(data);
                    oTable.setModel(oModel);
                    oTable.bindItems({
                        path: "/",
                        template: new sap.m.ColumnListItem({
                            cells: [
                                new sap.m.Text({text: "{dni}"}),
                                new sap.m.Text({text: "{nombre}"}),
                                new sap.m.Text({text: "{fechahora}"}),
                                new sap.m.Text({text: "{reloj}"}),
                                new sap.m.Text({text: "{tipo_marcaje}"})
                            ]
                        })
                    });
                }
            })
            .catch(error => {
                console.error('Error cargando datos de asistencia:', error);
            });
        }
        
        function showMessage(message, type) {
            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            messages.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }
        
        function displaySyncSummary(summary) {
            const statusDiv = document.getElementById('liveStatus');
            let total = 0;
            const html = Object.keys(summary || {}).map(k => {
                const c = summary[k] || {};
                const processed = Number(c.processedNew || 0);
                total += processed;
                return `<div class="device-card">
                    <h4>Dispositivo: ${c.clock || k}</h4>
                    <p><strong>IP:</strong> ${c.ip || ''}</p>
                    <p><strong>En BD:</strong> ${c.dbCount || 0}</p>
                    <p><strong>Obtenidas:</strong> ${c.obtainedCount || 0}</p>
                    <p><strong>Nuevas procesadas:</strong> ${processed}</p>
                </div>`;
            }).join('');
            statusDiv.innerHTML = `<h3>Resumen de sincronizaci贸n completa</h3>${html}<div class="device-card"><p><strong>Total:</strong> ${total} marcaciones procesadas exitosamente</p></div>`;
        }

        function parseAndRenderSummaryFromText(text) {
            if (!text || text.indexOf('RESUMEN DE SINCRONIZACIN COMPLETA') === -1) return;
            const lines = text.split(/\r?\n/);
            const summary = {};
            let total = 0;
            lines.forEach(l => {
                const m = l.match(/\s*(\S+):\s*(\d+)\s+marcaciones\s+procesadas/i);
                if (m) {
                    const clock = m[1];
                    const count = parseInt(m[2], 10) || 0;
                    summary[clock] = { clock, processedNew: count };
                    total += count;
                }
            });
            if (Object.keys(summary).length > 0) {
                displaySyncSummary(summary);
            }
        }

        function renderLiveStatus(clocks) { return; }

        function parseLogLineForDeviceStatus(line, clocks) {
            if (!line) return;
            let m;
            m = line.match(/Intento\s*(\d+)\/(\d+)\s*-\s*Conectando\s*a\s*(\S+)\s*\(([^)]+)\)/i);
            if (m) {
                const intento = `${m[1]}/${m[2]}`;
                const clock = m[3];
                const ip = m[4];
                clocks[clock] = { ...(clocks[clock]||{}), clock, ip, status: `Intento ${intento} conectando` };
                return;
            }
            m = line.match(/Conectado\s+exitosamente\s+a\s*(\S+)\s*\(([^)]+)\)/i);
            if (m) {
                const clock = m[1];
                const ip = m[2];
                clocks[clock] = { ...(clocks[clock]||{}), clock, ip, status: 'Conectado' };
                return;
            }
            m = line.match(/\s*(\S+):\s*(\d+)\s+marcaciones\s+obtenidas/i);
            if (m) {
                const clock = m[1];
                const count = parseInt(m[2],10)||0;
                clocks[clock] = { ...(clocks[clock]||{}), clock, obtainedCount: count };
                return;
            }
            m = line.match(/\s*(\S+):\s*(\d+)\s+marcaciones\s+en\s+BD/i);
            if (m) {
                const clock = m[1];
                const count = parseInt(m[2],10)||0;
                clocks[clock] = { ...(clocks[clock]||{}), clock, dbCount: count };
                return;
            }
        }

        function isNoiseLine(line) { return false; }
        function isJsonLoadingLine(line) { return false; }
        function sanitizeLine(line) {
            return (line || '').replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F]/g, '');
        }
    </script>
</body>
</html>
