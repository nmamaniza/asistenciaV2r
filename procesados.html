<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procesados - Sistema de Asistencia</title>
    <script src="https://sapui5.hana.ondemand.com/resources/sap-ui-core.js" data-sap-ui-theme="sap_fiori_3"
        data-sap-ui-libs="sap.m,sap.ui.core" data-sap-ui-compatVersion="edge" data-sap-ui-async="true">
        </script>
    <script src="/asistenciaV2r/js/menu-manager.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }

        .header {
            background-color: #0070f3;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        /* Estilos del men煤 de usuario */
        .user-menu {
            position: relative;
            display: inline-block;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ffffff;
            color: #0070f3;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .user-avatar:hover {
            background-color: #f0f0f0;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 5px;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-header {
            padding: 12px 16px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            font-weight: bold;
            color: #495057;
        }

        .dropdown-item {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background-color 0.3s ease;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-item.logout {
            border-top: 1px solid #e9ecef;
            color: #dc3545;
        }

        .dropdown-item.logout:hover {
            background-color: #f8d7da;
        }

        .content {
            padding: 1rem;
            max-width: 100%;
            margin: 0;
        }

        .page-title {
            color: #333;
            margin-bottom: 2rem;
            font-size: 2rem;
        }

        .info-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
    </style>
</head>

<body class="sapUiBody">
    <div class="header">
        <h1>Procesados - Sistema de Asistencia</h1>
        <div class="user-menu">
            <div class="user-avatar" id="userAvatar" onclick="toggleDropdown()">
                U
            </div>
            <div class="dropdown-menu" id="dropdownMenu">
                <div class="dropdown-header" id="dropdownHeader">Administrador</div>
                <a href="/asistenciaV2r/dashboard_admin.html" class="dropdown-item"> Dashboard Admin</a>
                <a href="/asistenciaV2r/biometric_sync.html" class="dropdown-item"> Sincronizaci贸n</a>
                <a href="/asistenciaV2r/procesados.html" class="dropdown-item"> Procesados</a>
                <a href="/asistenciaV2r/permisos.html" class="dropdown-item"> Permisos</a>
                <a href="/asistenciaV2r/consolidado.html" class="dropdown-item"> Consolidado</a>
                <a href="/asistenciaV2r/calendario.html" class="dropdown-item"> Calendario Laboral</a>
                <a href="/asistenciaV2r/perfil.html" class="dropdown-item"> Perfil</a>
                <a href="/asistenciaV2r/perfiles.html" class="dropdown-item"> Perfiles</a>
                <a href="/asistenciaV2r/logout" class="dropdown-item logout"> Cerrar Sesi贸n</a>
            </div>
        </div>
    </div>

    <div class="content">
        <h2 class="page-title">Datos Procesados</h2>
        <div class="info-card">
            <div id="processedContent"></div>
            <div id="processLogPanel" style="margin-top:16px">
                <h3>Salida del Proceso</h3>
                <pre id="processLog"
                    style="background:#ffffff;color:#333;border:1px solid #e0e0e0;border-radius:6px;max-height:300px;overflow:auto;padding:12px"></pre>
            </div>
        </div>
    </div>

    <script>
        sap.ui.getCore().attachInit(function () {
            if (window.menuManager) {
                window.menuManager.init();
            }
            sap.ui.require([
                "sap/m/Panel",
                "sap/m/Table",
                "sap/m/Column",
                "sap/m/Text",
                "sap/m/ColumnListItem",
                "sap/ui/model/json/JSONModel",
                "sap/m/MessageToast"
            ], function (Panel, Table, Column, Text, ColumnListItem, JSONModel, MessageToast) {

                // Crear modelo de datos
                var oModel = new JSONModel({
                    processedData: [],
                    count: 0
                });

                // Funci贸n para cargar datos procesados
                function loadProcessedData() {
                    fetch('/asistenciaV2r/processedData')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Error en la respuesta del servidor: ' + response.status);
                            }
                            return response.json();
                        })
                        .then(data => {
                            oModel.setData({
                                processedData: data,
                                count: data.length
                            });
                            MessageToast.show("Datos procesados cargados correctamente");
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            MessageToast.show("Error al cargar los datos procesados: " + error.message);
                            oModel.setData({
                                processedData: [],
                                count: 0
                            });
                        });
                }

                // Panel de par谩metros y filtros
                var oModel = new JSONModel({
                    processedData: [],
                    count: 0,
                    filters: { anio: '', mes: '', q: '' },
                    params: { fechaInicio: '', fechaFin: '', dni: '' },
                    running: false
                });

                var paramsBar = new sap.m.Toolbar({
                    content: [
                        new sap.m.Label({ text: 'Fecha Inicio:' }),
                        new sap.m.DatePicker({ value: '{/params/fechaInicio}' }),
                        new sap.m.Label({ text: 'Fecha Fin:' }),
                        new sap.m.DatePicker({ value: '{/params/fechaFin}' }),
                        new sap.m.Label({ text: 'DNI:' }),
                        new sap.m.Input({ value: '{/params/dni}', width: '150px' }),
                        new sap.m.Button({ text: 'Procesar', type: 'Emphasized', press: startProcess })
                    ]
                });

                var filterBar = new sap.m.Toolbar({
                    content: [
                        new sap.m.Label({ text: 'A帽o:' }),
                        new sap.m.Input({ value: '{/filters/anio}', width: '100px' }),
                        new sap.m.Label({ text: 'Mes:' }),
                        new sap.m.Input({ value: '{/filters/mes}', width: '80px' }),
                        new sap.m.SearchField({ value: '{/filters/q}', width: '200px', liveChange: loadProcessedData }),
                        new sap.m.Button({ text: 'Buscar', press: loadProcessedData })
                    ]
                });

                var oPanel = new Panel({
                    headerText: "Datos Procesados",
                    expandable: false,
                    expanded: true,
                    content: [paramsBar, filterBar]
                });

                // Crear tabla de datos procesados
                function formatYMD(v) {
                    if (v == null) return "";
                    var d;
                    if (typeof v === "number") {
                        d = new Date(v);
                    } else if (typeof v === "string") {
                        if (/^\d+$/.test(v)) {
                            d = new Date(parseInt(v, 10));
                        } else {
                            var m = v.match(/^(\d{4})-(\d{2})-(\d{2})$/);
                            if (m) return m[1] + "-" + m[2] + "-" + m[3];
                            d = new Date(v);
                        }
                    } else if (v instanceof Date) {
                        d = v;
                    } else {
                        return String(v);
                    }
                    if (isNaN(d.getTime())) return String(v);
                    var y = d.getFullYear();
                    var m = String(d.getMonth() + 1).padStart(2, '0');
                    var day = String(d.getDate()).padStart(2, '0');
                    return y + "-" + m + "-" + day;
                }

                var oTable = new Table({
                    inset: false,
                    width: "100%",
                    columns: [
                        new Column({ width: "80px", header: new Text({ text: "ID" }) }),
                        new Column({ width: "120px", header: new Text({ text: "DNI" }) }),
                        new Column({ width: "150px", header: new Text({ text: "Modalidad" }) }),
                        new Column({ width: "150px", header: new Text({ text: "Cargo" }) }),
                        new Column({ width: "150px", header: new Text({ text: "rea" }) }),
                        new Column({ width: "200px", header: new Text({ text: "Nombre" }) }),
                        new Column({ width: "120px", header: new Text({ text: "Fecha" }) }),
                        new Column({ width: "120px", header: new Text({ text: "Observaci贸n" }) }),
                        new Column({ width: "180px", header: new Text({ text: "Documentos" }) }),
                        new Column({ width: "140px", header: new Text({ text: "Final" }) }),
                        new Column({ width: "240px", header: new Text({ text: "Hora Interna" }) })
                    ]
                });

                // Template para las filas
                var oTemplate = new ColumnListItem({
                    cells: [
                        new Text({ text: "{id}" }),
                        new Text({ text: "{dni}" }),
                        new Text({ text: "{modalidad}" }),
                        new Text({ text: "{cargo}" }),
                        new Text({ text: "{area}" }),
                        new Text({ text: "{nombre}" }),
                        new sap.m.Text({ text: { path: "fecha", formatter: formatYMD } }),
                        new Text({ text: "{obs}" }),
                        new sap.m.Input({ value: "{doc}", width: '160px', change: onRowEdit }),
                        new sap.m.Input({ value: "{final}", width: '120px', change: onRowEdit }),
                        new Text({ text: "{horaint}" })
                    ]
                });

                // Vincular datos a la tabla
                oTable.bindItems({ path: "/processedData", template: oTemplate });

                // Agregar tabla al panel
                oPanel.addContent(oTable);

                // Establecer modelo
                oPanel.setModel(oModel);
                oTable.setModel(oModel);

                // Renderizar en el contenedor
                oPanel.placeAt("processedContent");

                // Cargar datos iniciales
                loadProcessedData();

                function loadProcessedData() {
                    const f = oModel.getProperty('/filters');
                    const qs = new URLSearchParams();
                    if (f.anio) qs.append('anio', f.anio);
                    if (f.mes) qs.append('mes', f.mes);
                    if (f.q) qs.append('q', f.q);
                    fetch('/asistenciaV2r/api/processed-data?' + qs.toString(), { credentials: 'include' })
                        .then(response => {
                            const ct = response.headers.get('content-type') || '';
                            if (!response.ok || ct.indexOf('application/json') === -1) {
                                return response.text().then(t => { throw new Error('Respuesta no JSON (' + response.status + '): ' + t.slice(0, 200)); });
                            }
                            return response.json();
                        })
                        .then(data => { oModel.setProperty('/processedData', Array.isArray(data) ? data : []); })
                        .catch(err => sap.m.MessageToast.show('Error: ' + err.message));
                }

                function startProcess() {
                    var p = oModel.getProperty('/params');
                    const qs = new URLSearchParams();
                    if (p.fechaInicio) qs.append('fechaInicio', p.fechaInicio);
                    if (p.fechaFin) qs.append('fechaFin', p.fechaFin);
                    if (p.dni) qs.append('dni', p.dni);
                    fetch('/asistenciaV2r/api/process-attendance?action=startScript&' + qs.toString(), { credentials: 'include' })
                        .then(r => {
                            const ct = r.headers.get('content-type') || '';
                            if (!r.ok || ct.indexOf('application/json') === -1) {
                                return r.text().then(t => { throw new Error('Respuesta no JSON (' + r.status + '): ' + t.slice(0, 200)); });
                            }
                            return r.json();
                        })
                        .then(j => {
                            sap.m.MessageToast.show(j.message || 'Proceso iniciado');
                            try { if (window._procES) { window._procES.close(); } } catch (e) { }
                            const pre = document.getElementById('processLog');
                            pre.textContent = '';
                            window._procES = new EventSource('/asistenciaV2r/api/process-attendance?action=stream');
                            let pending = [];
                            let flushScheduled = false;
                            function flushBatch() {
                                if (!pending.length) { flushScheduled = false; return; }
                                const text = pending.join('\n');
                                pre.textContent += text + '\n';
                                pending = [];
                                flushScheduled = false;
                                pre.scrollTop = pre.scrollHeight;
                            }
                            window._procES.onmessage = (ev) => {
                                const line = ev && ev.data || '';
                                if (line.indexOf('"type":"end"') !== -1) {
                                    try { window._procES.close(); } catch (e) { }
                                    flushBatch();
                                    // refrescar grilla al terminar
                                    loadProcessedData();
                                    return;
                                }
                                pending.push(line);
                                if (!flushScheduled) { flushScheduled = true; setTimeout(flushBatch, 250); }
                            };
                            window._procES.onerror = () => { try { window._procES.close(); } catch (e) { } };
                        })
                        .catch(e => sap.m.MessageToast.show('Error: ' + e.message));
                }

                function onRowEdit(ev) {
                    const ctx = ev.getSource().getBindingContext();
                    const data = ctx.getObject();
                    const qs = new URLSearchParams();
                    qs.append('id', data.id);
                    qs.append('doc', data.doc || '');
                    qs.append('final', data.final || '');
                    fetch('/asistenciaV2r/api/processed-update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: qs.toString(),
                        credentials: 'include'
                    }).then(r => {
                        const ct = r.headers.get('content-type') || '';
                        if (!r.ok || ct.indexOf('application/json') === -1) {
                            return r.text().then(t => { throw new Error('Respuesta no JSON (' + r.status + '): ' + t.slice(0, 200)); });
                        }
                        return r.json();
                    }).then(j => {
                        sap.m.MessageToast.show(j.message || (j.success ? 'Actualizado' : 'Error'));
                    }).catch(e => sap.m.MessageToast.show('Error: ' + e.message));
                }
            });
        });

        // Funci贸n para el men煤 desplegable
        function toggleDropdown() {
            var dropdown = document.getElementById('dropdownMenu');
            dropdown.classList.toggle('show');
        }

        // Cerrar el men煤 si se hace clic fuera de 茅l
        window.onclick = function (event) {
            if (!event.target.matches('.user-avatar')) {
                var dropdowns = document.getElementsByClassName('dropdown-menu');
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        // Obtener informaci贸n del usuario y actualizar el avatar
        function loadUserInfo() {
            fetch('/asistenciaV2r/userInfo')
                .then(response => response.json())
                .then(data => {
                    if (data.nombre) {
                        document.getElementById('userAvatar').textContent = data.nombre.charAt(0).toUpperCase();
                        document.querySelector('.dropdown-header').textContent = data.nombre;
                    }
                })
                .catch(error => {
                    console.log('No se pudo cargar la informaci贸n del usuario');
                });
        }

        // Cargar informaci贸n del usuario al iniciar
        loadUserInfo();
    </script>
</body>

</html>