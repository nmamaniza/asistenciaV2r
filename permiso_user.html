<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Permisos - Sistema de Asistencia</title>
    <script src="https://sapui5.hana.ondemand.com/resources/sap-ui-core.js" data-sap-ui-theme="sap_fiori_3"
        data-sap-ui-libs="sap.m,sap.ui.core" data-sap-ui-compatVersion="edge" data-sap-ui-async="true">
        </script>
    <script src="/asistenciaV2r/js/menu-manager.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }

        .header {
            background-color: #0070f3;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        /* Estilos del menú de usuario */
        .user-menu {
            position: relative;
            display: inline-block;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ffffff;
            color: #0070f3;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .user-avatar:hover {
            background-color: #f0f0f0;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 5px;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-header {
            padding: 12px 16px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            font-weight: bold;
            color: #495057;
        }

        .dropdown-item {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background-color 0.3s ease;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-item.logout {
            border-top: 1px solid #e9ecef;
            color: #dc3545;
        }

        .dropdown-item.logout:hover {
            background-color: #f8d7da;
        }

        .content {
            padding: 1rem;
            max-width: 100%;
            margin: 0;
        }

        .page-title {
            color: #333;
            margin-bottom: 2rem;
            font-size: 2rem;
        }

        .info-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
    </style>
</head>

<body class="sapUiBody">
    <div class="header">
        <h1>Mis Permisos - Sistema de Asistencia</h1>
        <div class="user-menu">
            <div class="user-avatar" id="userAvatar" onclick="toggleDropdown()">
                U
            </div>
            <div class="dropdown-menu" id="dropdownMenu">
                <div class="dropdown-header" id="dropdownHeader">Usuario</div>
            </div>
        </div>
    </div>

    <div class="content">
        <h2 class="page-title">Mis Permisos</h2>
        <div class="info-card">
            <div id="permissionsContent"></div>
        </div>
    </div>

    <script>
        sap.ui.getCore().attachInit(function () {
            if (window.menuManager) {
                window.menuManager.init();
            }
            sap.ui.require([
                "sap/m/Panel",
                "sap/m/Table",
                "sap/m/Column",
                "sap/m/Text",
                "sap/m/ColumnListItem",
                "sap/ui/model/json/JSONModel",
                "sap/m/MessageToast",
                "sap/m/Toolbar",
                "sap/m/Label",
                "sap/m/DatePicker",
                "sap/m/Button"
            ], function (Panel, Table, Column, Text, ColumnListItem, JSONModel, MessageToast, Toolbar, Label, DatePicker, Button) {

                // Crear modelo de datos
                var oModel = new JSONModel({
                    permissions: [],
                    count: 0,
                    filters: { fechaInicio: '', fechaFin: '' }
                });

                // Barra de filtros
                var filterBar = new Toolbar({
                    content: [
                        new Label({ text: 'Fecha Inicio:' }),
                        new DatePicker({
                            value: '{/filters/fechaInicio}',
                            valueFormat: 'yyyy-MM-dd',
                            displayFormat: 'dd/MM/yyyy'
                        }),
                        new Label({ text: 'Fecha Fin:' }),
                        new DatePicker({
                            value: '{/filters/fechaFin}',
                            valueFormat: 'yyyy-MM-dd',
                            displayFormat: 'dd/MM/yyyy'
                        }),
                        new Button({ text: 'Buscar', type: 'Emphasized', press: loadPermissions })
                    ]
                });

                var oPanel = new Panel({
                    headerText: "Mis Permisos Registrados",
                    expandable: false,
                    expanded: true,
                    content: [filterBar]
                });

                // Función para formatear fechas
                function formatDate(v) {
                    if (!v) return "";
                    try {
                        if (typeof v === 'number' || /^\d+$/.test(String(v))) {
                            const timestamp = parseInt(String(v));
                            const timestampMs = timestamp > 9999999999 ? timestamp : timestamp * 1000;
                            const date = new Date(timestampMs);
                            return date.toLocaleDateString('es-ES');
                        }
                        const date = new Date(v);
                        return date.toLocaleDateString('es-ES');
                    } catch (e) {
                        return String(v);
                    }
                }

                // Crear tabla de permisos
                var oTable = new Table({
                    inset: false,
                    width: "100%",
                    columns: [
                        new Column({ width: "120px", header: new Text({ text: "Tipo" }) }),
                        new Column({ width: "200px", header: new Text({ text: "Descripción" }) }),
                        new Column({ width: "150px", header: new Text({ text: "Cargo" }) }),
                        new Column({ width: "100px", header: new Text({ text: "Modo" }) }),
                        new Column({ width: "120px", header: new Text({ text: "Fecha Inicio" }) }),
                        new Column({ width: "120px", header: new Text({ text: "Fecha Fin" }) }),
                        new Column({ width: "100px", header: new Text({ text: "Estado" }) }),
                        new Column({ width: "150px", header: new Text({ text: "Fecha Registro" }) })
                    ]
                });

                // Template para las filas
                var oTemplate = new ColumnListItem({
                    cells: [
                        new Text({ text: "{codigo}" }),
                        new Text({ text: "{descripcion}" }),
                        new Text({ text: "{cargo}" }),
                        new Text({ text: "{modo}" }),
                        new Text({ text: { path: "fechaini", formatter: formatDate } }),
                        new Text({ text: { path: "fechafin", formatter: formatDate } }),
                        new Text({
                            text: {
                                path: "estado",
                                formatter: function (v) { return (parseInt(v, 10) === 1) ? 'Activo' : 'Inactivo'; }
                            }
                        }),
                        new Text({ text: { path: "created_at", formatter: function (v) { return v ? new Date(v).toLocaleString() : ""; } } })
                    ]
                });

                // Vincular datos a la tabla
                oTable.bindItems({ path: "/permissions", template: oTemplate });

                // Agregar tabla al panel
                oPanel.addContent(oTable);

                // Establecer modelo
                oPanel.setModel(oModel);
                oTable.setModel(oModel);

                // Renderizar en el contenedor
                oPanel.placeAt("permissionsContent");

                // Función para cargar permisos del usuario
                function loadPermissions() {
                    const f = oModel.getProperty('/filters');
                    const qs = new URLSearchParams();
                    if (f.fechaInicio) qs.append('fechaInicio', f.fechaInicio);
                    if (f.fechaFin) qs.append('fechaFin', f.fechaFin);

                    fetch('/asistenciaV2r/api/permissions-user?' + qs.toString(), { credentials: 'include' })
                        .then(response => {
                            const ct = response.headers.get('content-type') || '';
                            if (!response.ok || ct.indexOf('application/json') === -1) {
                                return response.text().then(t => { throw new Error('Respuesta no JSON (' + response.status + '): ' + t.slice(0, 200)); });
                            }
                            return response.json();
                        })
                        .then(data => {
                            oModel.setProperty('/permissions', Array.isArray(data) ? data : []);
                            oModel.setProperty('/count', Array.isArray(data) ? data.length : 0);
                            MessageToast.show("Permisos cargados: " + (Array.isArray(data) ? data.length : 0) + " registros");
                        })
                        .catch(err => {
                            MessageToast.show('Error: ' + err.message);
                            oModel.setProperty('/permissions', []);
                            oModel.setProperty('/count', 0);
                        });
                }

                // Cargar datos iniciales
                loadPermissions();
            });
        });
    </script>
</body>

</html>