<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Consolidado - Asignaciones de Trabajo</title>
    <script src="resources/sap-ui-core/sap-ui-core.js" 
            data-sap-ui-libs="sap.m,sap.ui.table" 
            data-sap-ui-theme="sap_horizon">
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        
        .header {
            background-color: #3498db;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .user-menu {
            position: relative;
            display: inline-block;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ffffff;
            color: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
        }
        
        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .dropdown-menu.show {
            display: block;
        }
        
        .dropdown-header {
            padding: 12px 16px;
            background-color: #f8f9fa;
            font-weight: bold;
            color: #333;
        }
        
        .dropdown-item {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background-color 0.3s;
        }
        
        .dropdown-item:hover {
            background-color: #f1f1f1;
        }
        
        .dropdown-item.logout:hover {
            background-color: #f8d7da;
        }
        
        .content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .filters-section {
            background-color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .filters-row {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }
        
        .filter-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .filter-group input, .filter-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .search-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            height: fit-content;
        }
        
        .search-btn:hover {
            background-color: #2980b9;
        }
        
        .export-btn {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }
        
        .export-btn:hover {
            background-color: #229954;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .summary-card h3 {
            margin: 0 0 10px 0;
            color: #3498db;
            font-size: 2rem;
        }
        
        .summary-card p {
            margin: 0;
            color: #666;
            font-weight: bold;
        }
        
        .table-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1> Consolidado de Asignaciones de Trabajo</h1>
        <div class="user-menu">
            <div class="user-avatar" id="userAvatar" onclick="toggleDropdown()">
                U
            </div>
            <div class="dropdown-menu" id="dropdownMenu">
                <div class="dropdown-header" id="dropdownHeader">Administrador</div>
                <a href="/asistenciaV2r/dashboard_admin.html" class="dropdown-item"> Dashboard Admin</a>
                <a href="/asistenciaV2r/biometric_sync.html" class="dropdown-item"> Sincronizaci贸n</a>
                <a href="/asistenciaV2r/procesados.html" class="dropdown-item"> Procesados</a>
                <a href="/asistenciaV2r/permisos.html" class="dropdown-item"> Permisos</a>
                <a href="/asistenciaV2r/consolidado.html" class="dropdown-item"> Consolidado Asistencia</a>
                <a href="/asistenciaV2r/perfil.html" class="dropdown-item"> Perfil</a>
                <a href="/asistenciaV2r/perfiles.html" class="dropdown-item"> Perfiles</a>
                <a href="/asistenciaV2r/jobassignments_report.html" class="dropdown-item"> Asignaciones Trabajo</a>
                <a href="/asistenciaV2r/logout" class="dropdown-item logout"> Cerrar Sesi贸n</a>
            </div>
        </div>
    </div>

    <div class="content">
        <div class="filters-section">
            <h3>Filtros de B煤squeda</h3>
            <div class="filters-row">
                <div class="filter-group">
                    <label for="modalidadFilter">Modalidad:</label>
                    <select id="modalidadFilter">
                        <option value="TODOS">TODOS</option>
                        <option value="CAS">CAS</option>
                        <option value="CAP">CAP</option>
                        <option value="NOMBRADO">NOMBRADO</option>
                        <option value="CONTRATADO">CONTRATADO</option>
                        <option value="TEMPORAL">TEMPORAL</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="areaFilter">rea:</label>
                    <select id="areaFilter">
                        <option value="TODOS">TODOS</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="equipoFilter">Equipo:</label>
                    <select id="equipoFilter">
                        <option value="TODOS">TODOS</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="estadoFilter">Estado:</label>
                    <select id="estadoFilter">
                        <option value="TODOS">TODOS</option>
                        <option value="1">ACTIVO</option>
                        <option value="0">INACTIVO</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="cargoFilter">Cargo:</label>
                    <input type="text" id="cargoFilter" placeholder="Buscar cargo...">
                </div>
                <div class="filter-group">
                    <label for="searchInput">Buscar (DNI/Nombre):</label>
                    <input type="text" id="searchInput" placeholder="Ingrese DNI o nombre">
                </div>
                <button class="search-btn" onclick="loadJobAssignmentsData()"> Buscar</button>
                <button class="export-btn" onclick="exportToCSV()"> Exportar CSV</button>
                <button class="export-btn" onclick="exportToExcel()" style="background-color: #217dbb;"> Exportar Excel</button>
            </div>
        </div>

        <div class="summary-cards">
            <div class="summary-card">
                <h3 id="totalAssignments">0</h3>
                <p>Total Asignaciones</p>
            </div>
            <div class="summary-card">
                <h3 id="activeAssignments">0</h3>
                <p>Asignaciones Activas</p>
            </div>
            <div class="summary-card">
                <h3 id="finishedAssignments">0</h3>
                <p>Asignaciones Finalizadas</p>
            </div>
            <div class="summary-card">
                <h3 id="avgSalary">0</h3>
                <p>Salario Promedio</p>
            </div>
        </div>

        <div class="table-container">
            <div id="assignmentsTable"></div>
            <div id="loadingMessage" class="loading">Cargando asignaciones de trabajo...</div>
        </div>
    </div>

    <script>
        // Funci贸n para mostrar/ocultar el men煤 desplegable
        function toggleDropdown() {
            const dropdown = document.getElementById("dropdownMenu");
            dropdown.classList.toggle("show");
        }

        // Cerrar el men煤 si se hace clic fuera de 茅l
        window.onclick = function(event) {
            if (!event.target.matches('.user-avatar')) {
                const dropdowns = document.getElementsByClassName("dropdown-menu");
                for (let i = 0; i < dropdowns.length; i++) {
                    const openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        // Cargar informaci贸n del usuario
        function loadUserInfo() {
            fetch('/asistenciaV2r/userInfo')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const avatar = document.getElementById('userAvatar');
                        const firstLetter = data.name ? data.name.charAt(0).toUpperCase() : 'U';
                        avatar.textContent = firstLetter;
                        
                        const header = document.getElementById('dropdownHeader');
                        header.textContent = data.name || 'Usuario';
                    }
                })
                .catch(error => {
                    console.log('No se pudo cargar la informaci贸n del usuario:', error);
                });
        }

        // Cargar datos de asignaciones
        function loadJobAssignmentsData() {
            const modalidad = document.getElementById('modalidadFilter').value;
            const area = document.getElementById('areaFilter').value;
            const equipo = document.getElementById('equipoFilter').value;
            const estado = document.getElementById('estadoFilter').value;
            const cargo = document.getElementById('cargoFilter').value;
            const search = document.getElementById('searchInput').value;
            
            const params = new URLSearchParams();
            if (modalidad && modalidad !== 'TODOS') params.append('modalidad', modalidad);
            if (area && area !== 'TODOS') params.append('area', area);
            if (equipo && equipo !== 'TODOS') params.append('equipo', equipo);
            if (estado && estado !== 'TODOS') params.append('estado', estado);
            if (cargo) params.append('cargo', cargo);
            if (search) params.append('q', search);
            
            document.getElementById('loadingMessage').style.display = 'block';
            fetch(`/asistenciaV2r/api/jobassignments-report?${params.toString()}`)
                .then(r => {
                    if (!r.ok) {
                        return r.text().then(t => { throw new Error('Error del servidor: ' + r.status + ' - ' + t.slice(0,200)); });
                    }
                    return r.json();
                })
                .then(response => {
                    document.getElementById('loadingMessage').style.display = 'none';
                    if (response.success) {
                        createAssignmentsTable(response.data);
                        updateSummaryCards(response.data);
                    } else {
                        throw new Error(response.message || 'Error al cargar datos');
                    }
                })
                .catch(err => {
                    document.getElementById('loadingMessage').style.display = 'none';
                    showError('Error: ' + err.message);
                    console.error('Error cargando asignaciones:', err);
                });
        }

        // Actualizar tarjetas de resumen
        function updateSummaryCards(data) {
            const total = data.length;
            const active = data.filter(item => item.estado_actual === 'VIGENTE').length;
            const finished = data.filter(item => item.estado_actual === 'FINALIZADO').length;
            const salaries = data.map(item => item.salario).filter(s => s != null);
            const avgSalary = salaries.length > 0 ? (salaries.reduce((a, b) => a + b, 0) / salaries.length).toFixed(2) : 0;
            
            document.getElementById('totalAssignments').textContent = total;
            document.getElementById('activeAssignments').textContent = active;
            document.getElementById('finishedAssignments').textContent = finished;
            document.getElementById('avgSalary').textContent = 'S/ ' + avgSalary;
        }

        // Crear tabla con SAPUI5
        function createAssignmentsTable(data) {
            // Limpiar contenedor anterior
            const container = document.getElementById('assignmentsTable');
            container.innerHTML = '';
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="loading">No se encontraron asignaciones de trabajo</div>';
                return;
            }
            
            const oModel = new sap.ui.model.json.JSONModel();
            oModel.setData({ assignments: data });
            
            const oTable = new sap.ui.table.Table({
                title: `Asignaciones de Trabajo (${data.length} registros)`,
                selectionMode: sap.ui.table.SelectionMode.MultiToggle,
                visibleRowCount: 20,
                enableColumnReordering: true,
                enableColumnFreeze: true,
                firstVisibleRow: 0
            });
            
            // Columnas
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.m.Label({ text: "DNI" }),
                template: new sap.m.Text({ text: "{dni}" }),
                width: "100px",
                hAlign: sap.ui.core.TextAlign.Left
            }));
            
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.m.Label({ text: "Nombre Completo" }),
                template: new sap.m.Text({ text: "{nombre_completo}" }),
                width: "200px",
                hAlign: sap.ui.core.TextAlign.Left
            }));
            
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.m.Label({ text: "Modalidad" }),
                template: new sap.m.Text({ text: "{modalidad}" }),
                width: "100px",
                hAlign: sap.ui.core.TextAlign.Center
            }));
            
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.m.Label({ text: "Cargo" }),
                template: new sap.m.Text({ text: "{cargo}" }),
                width: "150px",
                hAlign: sap.ui.core.TextAlign.Left
            }));
            
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.m.Label({ text: "rea" }),
                template: new sap.m.Text({ text: "{area}" }),
                width: "120px",
                hAlign: sap.ui.core.TextAlign.Left
            }));
            
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.m.Label({ text: "Equipo" }),
                template: new sap.m.Text({ text: "{equipo}" }),
                width: "100px",
                hAlign: sap.ui.core.TextAlign.Left
            }));
            
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.m.Label({ text: "Jefe" }),
                template: new sap.m.Text({ text: "{jefe}" }),
                width: "150px",
                hAlign: sap.ui.core.TextAlign.Left
            }));
            
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.m.Label({ text: "Fecha Inicio" }),
                template: new sap.m.Text({ text: "{path:'fechaini', formatter:'.formatDate'}" }),
                width: "100px",
                hAlign: sap.ui.core.TextAlign.Center
            }));
            
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.m.Label({ text: "Fecha Fin" }),
                template: new sap.m.Text({ text: "{path:'fechafin', formatter:'.formatDateOrEmpty'}" }),
                width: "100px",
                hAlign: sap.ui.core.TextAlign.Center
            }));
            
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.m.Label({ text: "Salario" }),
                template: new sap.m.Text({ text: "{path:'salario', formatter:'.formatCurrency'}" }),
                width: "80px",
                hAlign: sap.ui.core.TextAlign.Right
            }));
            
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.m.Label({ text: "Horario" }),
                template: new sap.m.Text({ text: "{horario}" }),
                width: "120px",
                hAlign: sap.ui.core.TextAlign.Left
            }));
            
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.m.Label({ text: "Estado" }),
                template: new sap.m.Text({ text: "{estado_actual}" }),
                width: "80px",
                hAlign: sap.ui.core.TextAlign.Center
            }));
            
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.m.Label({ text: "Observaciones" }),
                template: new sap.m.Text({ text: "{observaciones}" }),
                width: "200px",
                hAlign: sap.ui.core.TextAlign.Left
            }));
            
            oTable.setModel(oModel);
            oTable.bindRows("/assignments");
            
            // Agregar formatters
            oTable.addEventDelegate({
                onAfterRendering: function() {
                    // Formatters personalizados
                    const formatDate = function(date) {
                        if (!date) return '';
                        const d = new Date(date);
                        return d.toLocaleDateString('es-PE');
                    };
                    
                    const formatDateOrEmpty = function(date) {
                        if (!date) return 'VIGENTE';
                        const d = new Date(date);
                        return d.toLocaleDateString('es-PE');
                    };
                    
                    const formatCurrency = function(amount) {
                        if (!amount) return '';
                        return 'S/ ' + parseFloat(amount).toFixed(2);
                    };
                    
                    // Hacer disponibles los formatters globalmente
                    window.formatDate = formatDate;
                    window.formatDateOrEmpty = formatDateOrEmpty;
                    window.formatCurrency = formatCurrency;
                }
            });
            
            oTable.placeAt(container);
        }

        // Funci贸n para exportar a CSV
        function exportToCSV() {
            const modalidad = document.getElementById('modalidadFilter').value;
            const area = document.getElementById('areaFilter').value;
            const equipo = document.getElementById('equipoFilter').value;
            const estado = document.getElementById('estadoFilter').value;
            const cargo = document.getElementById('cargoFilter').value;
            const search = document.getElementById('searchInput').value;
            
            const params = new URLSearchParams();
            params.append('formato', 'csv');
            if (modalidad && modalidad !== 'TODOS') params.append('modalidad', modalidad);
            if (area && area !== 'TODOS') params.append('area', area);
            if (equipo && equipo !== 'TODOS') params.append('equipo', equipo);
            if (estado && estado !== 'TODOS') params.append('estado', estado);
            if (cargo) params.append('cargo', cargo);
            if (search) params.append('q', search);
            
            window.open(`/asistenciaV2r/api/jobassignments-report?${params.toString()}`, '_blank');
        }

        // Funci贸n para exportar a Excel (usa CSV pero con extensi贸n .xlsx)
        function exportToExcel() {
            exportToCSV(); // Por ahora usamos CSV, Excel puede abrirlo
        }

        // Funci贸n para mostrar errores
        function showError(message) {
            const container = document.getElementById('assignmentsTable');
            container.innerHTML = `<div class="error">${message}</div>`;
        }

        // Cargar datos iniciales
        function loadInitialData() {
            loadUserInfo();
            loadJobAssignmentsData();
            loadFilterOptions();
        }

        // Cargar opciones de filtros
        function loadFilterOptions() {
            // Cargar 谩reas
            fetch('/asistenciaV2r/api/areas')
                .then(r => r.json())
                .then(areas => {
                    const areaFilter = document.getElementById('areaFilter');
                    areas.forEach(area => {
                        const option = document.createElement('option');
                        option.value = area;
                        option.textContent = area;
                        areaFilter.appendChild(option);
                    });
                })
                .catch(err => console.error('Error cargando 谩reas:', err));
            
            // Cargar equipos
            fetch('/asistenciaV2r/api/equipos')
                .then(r => r.json())
                .then(equipos => {
                    const equipoFilter = document.getElementById('equipoFilter');
                    equipos.forEach(equipo => {
                        const option = document.createElement('option');
                        option.value = equipo;
                        option.textContent = equipo;
                        equipoFilter.appendChild(option);
                    });
                })
                .catch(err => console.error('Error cargando equipos:', err));
        }

        // Inicializar cuando el DOM est茅 listo
        document.addEventListener('DOMContentLoaded', loadInitialData);
    </script>
</body>
</html>