<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consolidado Mensual - Asignaciones de Trabajo</title>
    <script id="sap-ui-bootstrap"
            src="https://openui5.hana.ondemand.com/resources/sap-ui-core.js"
            data-sap-ui-libs="sap.m,sap.ui.table"
            data-sap-ui-theme="sap_horizon">
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        
        .header {
            background-color: #3498db;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .user-menu {
            position: relative;
            display: inline-block;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ffffff;
            color: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
        }
        
        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .dropdown-menu.show {
            display: block;
        }
        
        .dropdown-header {
            padding: 12px 16px;
            background-color: #f8f9fa;
            font-weight: bold;
            color: #333;
        }
        
        .dropdown-item {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background-color 0.3s;
        }
        
        .dropdown-item:hover {
            background-color: #f1f1f1;
        }
        
        .dropdown-item.logout:hover {
            background-color: #f8d7da;
        }
        
        .content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .filters-section {
            background-color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .filters-row {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }
        
        .filter-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .filter-group input, .filter-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .search-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            height: fit-content;
        }
        
        .search-btn:hover {
            background-color: #2980b9;
        }
        
        .export-btn {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }
        
        .export-btn:hover {
            background-color: #229954;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .summary-card h3 {
            margin: 0 0 10px 0;
            color: #3498db;
            font-size: 2rem;
        }
        
        .summary-card p {
            margin: 0;
            color: #666;
            font-weight: bold;
        }
        
        .table-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        .month-selector {
            background-color: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .legend {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .legend-item {
            display: inline-block;
            margin-right: 20px;
        }
        
        .legend-color {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 5px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìÖ Consolidado Mensual - Asignaciones de Trabajo</h1>
        <div class="user-menu">
            <div class="user-avatar" id="userAvatar" onclick="toggleDropdown()">
                U
            </div>
            <div class="dropdown-menu" id="dropdownMenu">
                <div class="dropdown-header" id="dropdownHeader">Administrador</div>
                <a href="/asistenciaV2r/dashboard_admin.html" class="dropdown-item">üè† Dashboard Admin</a>
                <a href="/asistenciaV2r/biometric_sync.html" class="dropdown-item">üîÑ Sincronizaci√≥n</a>
                <a href="/asistenciaV2r/procesados.html" class="dropdown-item">üìã Procesados</a>
                <a href="/asistenciaV2r/permisos.html" class="dropdown-item">üîê Permisos</a>
                <a href="/asistenciaV2r/consolidado.html" class="dropdown-item">üìä Consolidado Asistencia</a>
                <a href="/asistenciaV2r/perfil.html" class="dropdown-item">üë§ Perfil</a>
                <a href="/asistenciaV2r/perfiles.html" class="dropdown-item">üë• Perfiles</a>
                <a href="/asistenciaV2r/jobassignments_report.html" class="dropdown-item">üìã Asignaciones Trabajo</a>
                <a href="/asistenciaV2r/logout" class="dropdown-item logout">üö™ Cerrar Sesi√≥n</a>
            </div>
        </div>
    </div>

    <div class="content">
        <div class="month-selector">
            <h3>Seleccionar Mes</h3>
            <div class="filters-row">
                <div class="filter-group">
                    <label for="mesSelector">Mes:</label>
                    <input type="month" id="mesSelector" name="mesSelector">
                </div>
                <button class="search-btn" onclick="loadConsolidadoMensual()">üìÖ Cargar Mes</button>
                <button class="export-btn" onclick="exportarConsolidadoCSV()">üìä Exportar CSV</button>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item">
                <span class="legend-color" style="background-color: #28a745;"></span>
                <span>A = Asistencia</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background-color: #dc3545;"></span>
                <span>F = Falta</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background-color: #ffc107;"></span>
                <span>T = Tarde</span>
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background-color: #6c757d;"></span>
                <span>NF = No Laborable</span>
            </div>
        </div>

        <div class="summary-cards">
            <div class="summary-card">
                <h3 id="totalEmpleados">0</h3>
                <p>Total Empleados</p>
            </div>
            <div class="summary-card">
                <h3 id="totalAsistencias">0</h3>
                <p>Total Asistencias</p>
            </div>
            <div class="summary-card">
                <h3 id="totalFaltas">0</h3>
                <p>Total Faltas</p>
            </div>
            <div class="summary-card">
                <h3 id="totalTardes">0</h3>
                <p>Total Tardes</p>
            </div>
        </div>

        <div class="table-container">
            <div id="consolidadoTable"></div>
            <div id="loadingMessage" class="loading">Seleccione un mes para cargar el consolidado...</div>
        </div>
    </div>

    <script>
        // Funci√≥n para mostrar/ocultar el men√∫ desplegable
        function toggleDropdown() {
            const dropdown = document.getElementById("dropdownMenu");
            dropdown.classList.toggle("show");
        }

        // Cerrar el men√∫ si se hace clic fuera de √©l
        window.onclick = function(event) {
            if (!event.target.matches('.user-avatar')) {
                const dropdowns = document.getElementsByClassName("dropdown-menu");
                for (let i = 0; i < dropdowns.length; i++) {
                    const openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        // Cargar informaci√≥n del usuario
        function loadUserInfo() {
            fetch('/asistenciaV2r/userInfo')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const avatar = document.getElementById('userAvatar');
                        const firstLetter = data.name ? data.name.charAt(0).toUpperCase() : 'U';
                        avatar.textContent = firstLetter;
                        
                        const header = document.getElementById('dropdownHeader');
                        header.textContent = data.name || 'Usuario';
                    }
                })
                .catch(error => {
                    console.log('No se pudo cargar la informaci√≥n del usuario:', error);
                });
        }

        // Establecer mes actual por defecto
        function setCurrentMonth() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('mesSelector').value = `${year}-${month}`;
        }

        // Cargar consolidado mensual
        function loadConsolidadoMensual() {
            const mesValue = document.getElementById('mesSelector').value;
            if (!mesValue) {
                alert('Por favor seleccione un mes');
                return;
            }

            const [anio, mes] = mesValue.split('-');
            
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('loadingMessage').textContent = 'Cargando consolidado mensual...';
            
            fetch(`/asistenciaV2r/api/consolidado-mensual?anio=${anio}&mes=${mes}`)
                .then(r => {
                    if (!r.ok) {
                        return r.text().then(t => { throw new Error('Error del servidor: ' + r.status + ' - ' + t.slice(0,200)); });
                    }
                    return r.json();
                })
                .then(response => {
                    document.getElementById('loadingMessage').style.display = 'none';
                    if (response.success) {
                        createConsolidadoTable(response);
                        updateSummaryCards(response);
                    } else {
                        throw new Error(response.message || 'Error al cargar datos');
                    }
                })
                .catch(err => {
                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('loadingMessage').textContent = 'Error: ' + err.message;
                    console.error('Error cargando consolidado:', err);
                });
        }

        // Actualizar tarjetas de resumen
        function updateSummaryCards(response) {
            const data = response.data || [];
            let totalAsistencias = 0;
            let totalFaltas = 0;
            let totalTardes = 0;
            
            data.forEach(empleado => {
                const dias = empleado.dias || {};
                Object.values(dias).forEach(estado => {
                    if (estado === 'A') totalAsistencias++;
                    else if (estado === 'F') totalFaltas++;
                    else if (estado === 'T') totalTardes++;
                });
            });
            
            document.getElementById('totalEmpleados').textContent = data.length;
            document.getElementById('totalAsistencias').textContent = totalAsistencias;
            document.getElementById('totalFaltas').textContent = totalFaltas;
            document.getElementById('totalTardes').textContent = totalTardes;
        }

        // Crear tabla consolidada con SAPUI5
        function createConsolidadoTable(response) {
            console.log('Creating table with response:', response);
            
            // Limpiar contenedor anterior
            const container = document.getElementById('consolidadoTable');
            container.innerHTML = '';
            
            if (!response.data || response.data.length === 0) {
                container.innerHTML = '<div class="loading">No se encontraron datos para el mes seleccionado</div>';
                return;
            }
            
            const data = response.data;
            const anio = response.anio;
            const mes = response.mes;
            const diasEnMes = response.dias_en_mes;
            
            console.log('Data to display:', data);
            console.log('Number of records:', data.length);
            
            // Verificar si SAP UI5 est√° disponible
            if (typeof sap === 'undefined' || !sap.ui || !sap.ui.table) {
                console.error('SAP UI5 library not loaded');
                container.innerHTML = '<div class="loading">Error: SAP UI5 library not loaded</div>';
                return;
            }
            
            const oModel = new sap.ui.model.json.JSONModel();
            oModel.setData({ empleados: data });
            
            const oTable = new sap.ui.table.Table({
                title: `Consolidado Mensual - ${anio}-${String(mes).padStart(2, '0')} (${data.length} empleados)`,
                selectionMode: sap.ui.table.SelectionMode.None,
                visibleRowCount: Math.min(20, data.length),
                enableColumnReordering: true,
                enableColumnFreeze: true,
                firstVisibleRow: 0
            });
            
            // Columnas fijas
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.m.Label({ text: "DNI" }),
                template: new sap.m.Text({ text: "{dni}" }),
                width: "100px",
                hAlign: sap.ui.core.TextAlign.Left
            }));
            
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.m.Label({ text: "Nombre Completo" }),
                template: new sap.m.Text({ text: "{nombre_completo}" }),
                width: "200px",
                hAlign: sap.ui.core.TextAlign.Left
            }));
            
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.m.Label({ text: "Modalidad" }),
                template: new sap.m.Text({ text: "{modalidad}" }),
                width: "100px",
                hAlign: sap.ui.core.TextAlign.Center
            }));
            
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.m.Label({ text: "Cargo" }),
                template: new sap.m.Text({ text: "{cargo}" }),
                width: "150px",
                hAlign: sap.ui.core.TextAlign.Left
            }));
            
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.m.Label({ text: "√Årea" }),
                template: new sap.m.Text({ text: "{area}" }),
                width: "120px",
                hAlign: sap.ui.core.TextAlign.Left
            }));
            
            oTable.addColumn(new sap.ui.table.Column({
                label: new sap.m.Label({ text: "Horario" }),
                template: new sap.m.Text({ text: "{horario}" }),
                width: "120px",
                hAlign: sap.ui.core.TextAlign.Left
            }));
            
            // Columnas din√°micas para cada d√≠a del mes
            const fixedCols = 8; // DNI, Nombre, Modalidad, Cargo, √Årea, Equipo, Jefe, Horario
            for (let dia = 1; dia <= diasEnMes; dia++) {
                const diaStr = String(dia).padStart(2, '0');
                const textCell = new sap.m.Text({ wrapping: false });
                textCell.bindProperty("text", {
                    path: `dias/${dia}`,
                    formatter: function(val) { return val || ''; }
                });

                oTable.addColumn(new sap.ui.table.Column({
                    label: new sap.m.Label({ text: diaStr }),
                    template: textCell,
                    width: "30px",
                    hAlign: sap.ui.core.TextAlign.Center
                }));
            }
            
            oTable.setModel(oModel);
            oTable.bindRows("/empleados");
            
            // Agregar estilos por estado del d√≠a
            oTable.addEventDelegate({
                onAfterRendering: function() {
                    setTimeout(function() {
                        const rows = oTable.getRows();
                        rows.forEach(row => {
                            const cells = row.getCells();
                            const context = row.getBindingContext();
                            const dias = context.getProperty('dias') || {};

                            for (let i = fixedCols; i < cells.length; i++) {
                                const dia = i - fixedCols + 1; // D√≠a 1..N
                                const estado = dias[dia] || '';
                                const cell = cells[i].getDomRef();
                                if (cell) {
                                    cell.style.fontWeight = 'bold';
                                    cell.style.fontSize = '12px';
                                    switch (estado) {
                                        case 'A':
                                            cell.style.backgroundColor = '#d4edda';
                                            cell.style.color = '#155724';
                                            break;
                                        case 'F':
                                            cell.style.backgroundColor = '#f8d7da';
                                            cell.style.color = '#721c24';
                                            break;
                                        case 'T':
                                            cell.style.backgroundColor = '#fff3cd';
                                            cell.style.color = '#856404';
                                            break;
                                        case 'NF':
                                            cell.style.backgroundColor = '#e2e3e5';
                                            cell.style.color = '#383d41';
                                            break;
                                        default:
                                            cell.style.backgroundColor = '#f8f9fa';
                                            cell.style.color = '#6c757d';
                                    }
                                }
                            }
                        });
                    }, 100);
                }
            });
            
            console.log('Table created, setting model and placing...');
            oTable.setModel(oModel);
            
            try {
                oTable.placeAt(container);
                console.log('Table placed successfully');
            } catch (error) {
                console.error('Error placing table:', error);
                container.innerHTML = '<div class="loading">Error al crear la tabla: ' + error.message + '</div>';
            }
        }

        // Funci√≥n para exportar a CSV
        function exportarConsolidadoCSV() {
            const mesValue = document.getElementById('mesSelector').value;
            if (!mesValue) {
                alert('Por favor seleccione un mes');
                return;
            }
            
            const [anio, mes] = mesValue.split('-');
            window.open(`/asistenciaV2r/api/consolidado-mensual?anio=${anio}&mes=${mes}&formato=csv`, '_blank');
        }

        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            setCurrentMonth();
            // Cargar datos autom√°ticamente al iniciar
            setTimeout(loadConsolidadoMensual, 500);
        });
    </script>
</body>
</html>